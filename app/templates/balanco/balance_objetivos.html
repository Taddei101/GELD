{% extends "base.html" %}

{% block title %}Balancear Aporte - {{ cliente.nome }}{% endblock %}
{% block header %}Balancear Aporte - {{ cliente.nome }}{% endblock %}

{% block content %}
<div class="center">
    

    {#  TABELA DE FATIAS ALOCADAS (PERCENTUAIS SALVOS) #}
    <h3 style="margin-top: 20px; margin-bottom: 15px;"> Percentuais por Objetivo</h3>
        
    <div style="overflow-x: auto; margin-bottom: 30px;">
        <table class="table table-bordered table-sm" style="font-size: 0.85em; max-width: 800px;">
            <thead style="background-color: #f8f9fa;">
                <tr>
                    <th style="min-width: 120px;">Classe de Risco</th>
                    {% for objetivo in objetivos %}
                    <th class="text-center">{{ objetivo.nome_objetivo }}</th>
                    {% endfor %}
                    <th class="text-center" style="background-color: #e9ecef;"><strong>Total</strong></th>
                </tr>
            </thead>
            <tbody>
                {# Linha: Baixo DI #}
                <tr>
                    <td style="background-color: #d4edda;"><strong>Baixo DI</strong></td>
                    {% for objetivo in objetivos %}
                        {% set perc = percentuais_salvos[objetivo.id].baixo_di %}
                        <td class="text-center" style="background-color: #d4edda;">
                            {% if perc > 0 %}
                                {{ '{:.1f}'.format(perc) }}%
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td class="text-center" style="background-color: #c3e6cb;"><strong>100%</strong></td>
                </tr>
                
                {# Linha: Baixo RFx #}
                <tr>
                    <td style="background-color: #d4edda;"><strong>Baixo RFx</strong></td>
                    {% for objetivo in objetivos %}
                        {% set perc = percentuais_salvos[objetivo.id].baixo_rfx %}
                        <td class="text-center" style="background-color: #d4edda;">
                            {% if perc > 0 %}
                                {{ '{:.1f}'.format(perc) }}%
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td class="text-center" style="background-color: #c3e6cb;"><strong>100%</strong></td>
                </tr>
                
                {# Linha: Moderado #}
                <tr>
                    <td style="background-color: #fff3cd;"><strong>Moderado</strong></td>
                    {% for objetivo in objetivos %}
                        {% set perc = percentuais_salvos[objetivo.id].moderado %}
                        <td class="text-center" style="background-color: #fff3cd;">
                            {% if perc > 0 %}
                                {{ '{:.1f}'.format(perc) }}%
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td class="text-center" style="background-color: #ffeaa7;"><strong>100%</strong></td>
                </tr>
                
                {# Linha: Alto #}
                <tr>
                    <td style="background-color: #f8d7da;"><strong>Alto</strong></td>
                    {% for objetivo in objetivos %}
                        {% set perc = percentuais_salvos[objetivo.id].alto %}
                        <td class="text-center" style="background-color: #f8d7da;">
                            {% if perc > 0 %}
                                {{ '{:.1f}'.format(perc) }}%
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td class="text-center" style="background-color: #f5c6cb;"><strong>100%</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <hr style="margin: 30px 0;">
    
    
<!-- ALERTA se as fatias n√£o somarem 100% -->

{% if not fatias_validas %}
<div class="alert alert-warning" style="margin: 20px 0; padding: 15px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
    <h4 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Inconsist√™ncia Detectada nas Fatias!</h4>
    <p style="margin: 10px 0;">As fatias alocadas n√£o somam 100% em todas as classes:</p>
    <ul style="margin: 10px 0;">
        {% if somas_fatias.baixo_di > 0 and (somas_fatias.baixo_di < 99 or somas_fatias.baixo_di > 101) %}
        <li><strong>Baixo DI:</strong> {{ '{:.1f}%'.format(somas_fatias.baixo_di) }} (deveria ser 100%)</li>
        {% endif %}
        {% if somas_fatias.baixo_rfx > 0 and (somas_fatias.baixo_rfx < 99 or somas_fatias.baixo_rfx > 101) %}
        <li><strong>Baixo RFx:</strong> {{ '{:.1f}%'.format(somas_fatias.baixo_rfx) }} (deveria ser 100%)</li>
        {% endif %}
        {% if somas_fatias.moderado > 0 and (somas_fatias.moderado < 99 or somas_fatias.moderado > 101) %}
        <li><strong>Moderado:</strong> {{ '{:.1f}%'.format(somas_fatias.moderado) }} (deveria ser 100%)</li>
        {% endif %}
        {% if somas_fatias.alto > 0 and (somas_fatias.alto < 99 or somas_fatias.alto > 101) %}
        <li><strong>Alto:</strong> {{ '{:.1f}%'.format(somas_fatias.alto) }} (deveria ser 100%)</li>
        {% endif %}
    </ul>
    <p style="margin: 10px 0; font-weight: bold;">
        Isto pode ter sido causado por balanceamentos incompletos ou objetivos deletados.
    </p>
    <form method="POST" action="{{ url_for('balanco.recalcular_fatias', cliente_id=cliente.id) }}" style="margin-top: 15px;">
        <button type="submit" class="btn btn-warning" onclick="return confirm('Recalcular fatias baseado nas posi√ß√µes atuais?')">
            üîÑ Recalcular Fatias Automaticamente
        </button>
    </form>
</div>
{% endif %}

<!-- TABELA de aporte por objetivo  -->


    <h3> Aloca√ß√£o por Objetivo</h3>
    <form method="POST" action="{{ url_for('balanco.calcular', cliente_id=cliente.id) }}">
                        
        <div style="overflow-x: auto;">
        <table class="table table-bordered" style="font-size: 0.8em;">
            <thead class="thead-dark">
                <tr>
                    <th rowspan="2" style="vertical-align: middle; min-width: 120px;">Classe de Risco</th>
                    {% for objetivo in objetivos %}
                    <th colspan="5" class="text-center">
                        {{ objetivo.nome_objetivo }} ({{ objetivo.duracao_meses }}m)
                    </th>
                    {% endfor %}
                </tr>
                <tr style="font-size: 0.75em;">
                    {% for objetivo in objetivos %}
                    <th class="text-center">Tgt %</th>
                    <th class="text-center">Tgt R$</th>
                    <th class="text-center">Atual %</th>
                    <th class="text-center">Atual R$</th>
                    <th class="text-center">Gap R$</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <!-- Linha: Baixo DI -->
                <tr>
                    <td style="background-color: #d4edda;"><strong> Baixo DI</strong></td>
                    {% for objetivo in objetivos %}
                        {% set valores = valores_por_objetivo[objetivo.id] %}
                        {% set matriz = matrizes_risco[objetivo.id] %}
                        {% set total_atual = valores.total %}
                        
                        {% set target_pct = (matriz.perc_baixo * matriz.perc_di_dentro_baixo) / 100 %}
                        {% set target_reais = total_atual * target_pct / 100 %}
                        {% set atual_reais = valores.baixo_di %}
                        {% set gap = target_reais - atual_reais %}
                        
                        {% if total_atual > 0 %}
                            {% set atual_pct = (atual_reais / total_atual) * 100 %}
                        {% else %}
                            {% set atual_pct = 0 %}
                        {% endif %}
                        
                        <td class="text-center" style="background-color: #d4edda;">{{ '{:.1f}'.format(target_pct) }}%</td>
                        <td class="text-right" style="background-color: #d4edda;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                        <td class="text-center" style="background-color: {% if atual_pct < target_pct %}#fff3cd{% elif atual_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                            {{ '{:.1f}'.format(atual_pct) }}%
                        </td>
                        <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(atual_reais).replace(',', '.') }}</td>
                        <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                            {% if gap > 0 %}
                                <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                            {% elif gap < 0 %}
                                <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                            {% else %}
                                0
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                
                <!-- Linha: Baixo RFx -->
                <tr>
                    <td style="background-color: #d4edda;"><strong> Baixo RFx</strong></td>
                    {% for objetivo in objetivos %}
                        {% set valores = valores_por_objetivo[objetivo.id] %}
                        {% set matriz = matrizes_risco[objetivo.id] %}
                        {% set total_atual = valores.total %}
                        
                        {% set target_pct = (matriz.perc_baixo * matriz.perc_rfx_dentro_baixo) / 100 %}
                        {% set target_reais = total_atual * target_pct / 100 %}
                        {% set atual_reais = valores.baixo_rfx %}
                        {% set gap = target_reais - atual_reais %}
                        
                        {% if total_atual > 0 %}
                            {% set atual_pct = (atual_reais / total_atual) * 100 %}
                        {% else %}
                            {% set atual_pct = 0 %}
                        {% endif %}
                        
                        <td class="text-center" style="background-color: #d4edda;">{{ '{:.1f}'.format(target_pct) }}%</td>
                        <td class="text-right" style="background-color: #d4edda;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                        <td class="text-center" style="background-color: {% if atual_pct < target_pct %}#fff3cd{% elif atual_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                            {{ '{:.1f}'.format(atual_pct) }}%
                        </td>
                        <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(atual_reais).replace(',', '.') }}</td>
                        <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                            {% if gap > 0 %}
                                <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                            {% elif gap < 0 %}
                                <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                            {% else %}
                                0
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                
                <!-- Linha: Moderado -->
                <tr>
                    <td style="background-color: #fff3cd;"><strong> Moderado</strong></td>
                    {% for objetivo in objetivos %}
                        {% set valores = valores_por_objetivo[objetivo.id] %}
                        {% set matriz = matrizes_risco[objetivo.id] %}
                        {% set total_atual = valores.total %}
                        
                        {% set target_pct = matriz.perc_moderado %}
                        {% set target_reais = total_atual * target_pct / 100 %}
                        {% set atual_reais = valores.moderado %}
                        {% set gap = target_reais - atual_reais %}
                        
                        {% if total_atual > 0 %}
                            {% set atual_pct = (atual_reais / total_atual) * 100 %}
                        {% else %}
                            {% set atual_pct = 0 %}
                        {% endif %}
                        
                        <td class="text-center" style="background-color: #fff3cd;">{{ '{:.1f}'.format(target_pct) }}%</td>
                        <td class="text-right" style="background-color: #fff3cd;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                        <td class="text-center" style="background-color: {% if atual_pct < target_pct %}#fff3cd{% elif atual_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                            {{ '{:.1f}'.format(atual_pct) }}%
                        </td>
                        <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(atual_reais).replace(',', '.') }}</td>
                        <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                            {% if gap > 0 %}
                                <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                            {% elif gap < 0 %}
                                <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                            {% else %}
                                0
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                
                <!-- Linha: Alto -->
                <tr>
                    <td style="background-color: #f8d7da;"><strong> Alto</strong></td>
                    {% for objetivo in objetivos %}
                        {% set valores = valores_por_objetivo[objetivo.id] %}
                        {% set matriz = matrizes_risco[objetivo.id] %}
                        {% set total_atual = valores.total %}
                        
                        {% set target_pct = matriz.perc_alto %}
                        {% set target_reais = total_atual * target_pct / 100 %}
                        {% set atual_reais = valores.alto %}
                        {% set gap = target_reais - atual_reais %}
                        
                        {% if total_atual > 0 %}
                            {% set atual_pct = (atual_reais / total_atual) * 100 %}
                        {% else %}
                            {% set atual_pct = 0 %}
                        {% endif %}
                        
                        <td class="text-center" style="background-color: #f8d7da;">{{ '{:.1f}'.format(target_pct) }}%</td>
                        <td class="text-right" style="background-color: #f8d7da;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                        <td class="text-center" style="background-color: {% if atual_pct < target_pct %}#fff3cd{% elif atual_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                            {{ '{:.1f}'.format(atual_pct) }}%
                        </td>
                        <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(atual_reais).replace(',', '.') }}</td>
                        <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                            {% if gap > 0 %}
                                <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                            {% elif gap < 0 %}
                                <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                            {% else %}
                                0
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                
                <!-- Linha: Total Atual + Input Aporte -->
                <tr class="table-active">
                    <td><strong>TOTAL ATUAL</strong></td>
                    {% for objetivo in objetivos %}
                        {% set valores = valores_por_objetivo[objetivo.id] %}
                        <td colspan="4" class="text-right"><strong>R$ {{ '{:,.0f}'.format(valores.total).replace(',', '.') }}</strong></td>
                        <td></td>
                    {% endfor %}
                </tr>
                <tr class="table-primary">
                    <td><strong>APORTE (R$)</strong></td>
                    {% for objetivo in objetivos %}
                        <td colspan="5" class="text-center">
                            <input 
                                type="number" 
                                step="0.01" 
                                min="0" 
                                class="form-control" 
                                id="aporte_{{ objetivo.id }}"
                                name="aporte_{{ objetivo.id }}"
                                placeholder="0"
                                style="width: 150px; display: inline-block; font-size: 0.85em;"
                            >
                        </td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>
        </div>
        
<p></p>


<!-- Tabela De capital n√£o alocado -->

{% if total_orfao > 100 %}
<div class="alert alert-warning" style="margin-bottom: 20px;">
    <h3> Capital N√£o Alocado </h3>
    
    <table class="table table-sm" style="max-width: 400px;">
        <tbody>
            {% if capital_orfao.baixo_di > 1 %}
            <tr>
                <td><strong>Baixo DI:</strong></td>
                <td class="text-right">R$ {{ '{:,.0f}'.format(capital_orfao.baixo_di).replace(',', '.') }}</td>
            </tr>
            {% endif %}
            {% if capital_orfao.baixo_rfx > 1 %}
            <tr>
                <td><strong>Baixo RFx:</strong></td>
                <td class="text-right">R$ {{ '{:,.0f}'.format(capital_orfao.baixo_rfx).replace(',', '.') }}</td>
            </tr>
            {% endif %}
            {% if capital_orfao.moderado > 1 %}
            <tr>
                <td><strong>Moderado:</strong></td>
                <td class="text-right">R$ {{ '{:,.0f}'.format(capital_orfao.moderado).replace(',', '.') }}</td>
            </tr>
            {% endif %}
            {% if capital_orfao.alto > 1 %}
            <tr>
                <td><strong>Alto:</strong></td>
                <td class="text-right">R$ {{ '{:,.0f}'.format(capital_orfao.alto).replace(',', '.') }}</td>
            </tr>
            {% endif %}
            <tr style="border-top: 2px solid #000;">
                <td><strong>TOTAL:</strong></td>
                <td class="text-right"><strong>R$ {{ '{:,.0f}'.format(total_orfao).replace(',', '.') }}</strong></td>
            </tr>
        </tbody>
    </table>
</div>
{% endif %}


        <!-- RESUMO AGREGADO - Somatoria dos deltas de compra e venda em cada risco -->
        <div style="margin-top: 30px;">
            <h3> A√ß√µes Necess√°rias</h3>
            
            {# Calcular totais agregados #}
            {% set ns = namespace(
                target_di=0, atual_di=0,
                target_rfx=0, atual_rfx=0,
                target_moderado=0, atual_moderado=0,
                target_alto=0, atual_alto=0
            ) %}
            
            {% for objetivo in objetivos %}
                {% set valores = valores_por_objetivo[objetivo.id] %}
                {% set matriz = matrizes_risco[objetivo.id] %}
                {% set total_atual = valores.total %}
                
                {% set target_di_pct = (matriz.perc_baixo * matriz.perc_di_dentro_baixo) / 100 %}
                {% set target_rfx_pct = (matriz.perc_baixo * matriz.perc_rfx_dentro_baixo) / 100 %}
                {% set target_moderado_pct = matriz.perc_moderado %}
                {% set target_alto_pct = matriz.perc_alto %}
                
                {% set ns.target_di = ns.target_di + (total_atual * target_di_pct / 100) %}
                {% set ns.atual_di = ns.atual_di + valores.baixo_di %}
                
                {% set ns.target_rfx = ns.target_rfx + (total_atual * target_rfx_pct / 100) %}
                {% set ns.atual_rfx = ns.atual_rfx + valores.baixo_rfx %}
                
                {% set ns.target_moderado = ns.target_moderado + (total_atual * target_moderado_pct / 100) %}
                {% set ns.atual_moderado = ns.atual_moderado + valores.moderado %}
                
                {% set ns.target_alto = ns.target_alto + (total_atual * target_alto_pct / 100) %}
                {% set ns.atual_alto = ns.atual_alto + valores.alto %}
            {% endfor %}
            
            {% set gap_di = ns.target_di - ns.atual_di %}
            {% set gap_rfx = ns.target_rfx - ns.atual_rfx %}
            {% set gap_moderado = ns.target_moderado - ns.atual_moderado %}
            {% set gap_alto = ns.target_alto - ns.atual_alto %}
            
            <table class="table table-bordered" style="max-width: 500px;">
                <thead class="thead-dark">
                    <tr>
                        <th>Classe de Risco</th>
                        <th class="text-right">A√ß√£o Necess√°ria (R$)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong> Baixo DI</strong></td>
                        <td class="text-right" style="background-color: {% if gap_di > 0 %}#d4edda{% elif gap_di < 0 %}#f8d7da{% else %}#f8f9fa{% endif %};">
                            <strong>
                            {% if gap_di > 0 %}
                                +R$ {{ '{:,.0f}'.format(gap_di).replace(',', '.') }} <span style="color: green;">(COMPRAR)</span>
                            {% elif gap_di < 0 %}
                                -R$ {{ '{:,.0f}'.format(-gap_di).replace(',', '.') }} <span style="color: red;">(VENDER)</span>
                            {% else %}
                                R$ 0 <span style="color: gray;">(OK)</span>
                            {% endif %}
                            </strong>
                        </td>
                    </tr>
                    <tr>
                        <td><strong> Baixo RFx</strong></td>
                        <td class="text-right" style="background-color: {% if gap_rfx > 0 %}#d4edda{% elif gap_rfx < 0 %}#f8d7da{% else %}#f8f9fa{% endif %};">
                            <strong>
                            {% if gap_rfx > 0 %}
                                +R$ {{ '{:,.0f}'.format(gap_rfx).replace(',', '.') }} <span style="color: green;">(COMPRAR)</span>
                            {% elif gap_rfx < 0 %}
                                -R$ {{ '{:,.0f}'.format(-gap_rfx).replace(',', '.') }} <span style="color: red;">(VENDER)</span>
                            {% else %}
                                R$ 0 <span style="color: gray;">(OK)</span>
                            {% endif %}
                            </strong>
                        </td>
                    </tr>
                    <tr>
                        <td><strong> Moderado</strong></td>
                        <td class="text-right" style="background-color: {% if gap_moderado > 0 %}#d4edda{% elif gap_moderado < 0 %}#f8d7da{% else %}#f8f9fa{% endif %};">
                            <strong>
                            {% if gap_moderado > 0 %}
                                +R$ {{ '{:,.0f}'.format(gap_moderado).replace(',', '.') }} <span style="color: green;">(COMPRAR)</span>
                            {% elif gap_moderado < 0 %}
                                -R$ {{ '{:,.0f}'.format(-gap_moderado).replace(',', '.') }} <span style="color: red;">(VENDER)</span>
                            {% else %}
                                R$ 0 <span style="color: gray;">(OK)</span>
                            {% endif %}
                            </strong>
                        </td>
                    </tr>
                    <tr>
                        <td><strong> Alto</strong></td>
                        <td class="text-right" style="background-color: {% if gap_alto > 0 %}#d4edda{% elif gap_alto < 0 %}#f8d7da{% else %}#f8f9fa{% endif %};">
                            <strong>
                            {% if gap_alto > 0 %}
                                +R$ {{ '{:,.0f}'.format(gap_alto).replace(',', '.') }} <span style="color: green;">(COMPRAR)</span>
                            {% elif gap_alto < 0 %}
                                -R$ {{ '{:,.0f}'.format(-gap_alto).replace(',', '.') }} <span style="color: red;">(VENDER)</span>
                            {% else %}
                                R$ 0 <span style="color: gray;">(OK)</span>
                            {% endif %}
                            </strong>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            
        </div>
        
<!-- Bot√µes -->
    <div style="margin-top: 30px;">
        <button type="submit" class="bigBtn">
            <img src="{{ url_for('static', filename='icons/balance.png') }}" class="btn-icon">
            Calcular Balanceamento
        </button>
                
        <button type="button" title="Voltar" class="smlBtn" onclick="window.location.href='{{ url_for('cliente.area_cliente', cliente_id=cliente.id) }}'">
            <img src="{{ url_for('static', filename='icons/back.png') }}" class="sml-btn-icon">
        </button>
    </div>
</form>

</div>

<!-- <style>
.table {
    font-size: 0.8em;
}
.table th, .table td {
    padding: 5px;
    white-space: nowrap;
}
.table thead th {
    position: sticky;
    top: 0;
    z-index: 10;
}
</style> -->
{% endblock %}