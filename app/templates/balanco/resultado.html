{% extends "base.html" %}

{% block title %}Resultado - Balanceamento{% endblock %}
{% block header %}Resultado do Balanceamento - {{ cliente.nome }}{% endblock %}

{% block content %}

    
<div class="center">
    
    <h3 > Resultado do Balanceamento (PÃ³s-Aporte)</h3>
    
    <div style="overflow-x: auto;">
    <table class="table table-bordered" style="font-size: 0.8em;">
        <thead class="thead-dark">
            <tr>
                <th rowspan="2" style="vertical-align: middle; min-width: 120px;">Classe de Risco</th>
                {% for obj in resultado.resultados_por_objetivo %}
                <th colspan="5" class="text-center">
                    {{ obj.objetivo_nome }} ({{ obj.prazo_meses }}m)
                </th>
                {% endfor %}
            </tr>
            <tr style="font-size: 0.75em;">
                {% for obj in resultado.resultados_por_objetivo %}
                <th class="text-center">Tgt %</th>
                <th class="text-center">Tgt R$</th>
                <th class="text-center">Atual %</th>
                <th class="text-center">Atual R$</th>
                <th class="text-center">Gap R$</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <!-- Linha: Baixo DI -->
            <tr>
                <td style="background-color: #d4edda;"><strong> Baixo DI</strong></td>
                {% for obj in resultado.resultados_por_objetivo %}
                    {% set target_pct = obj.percentuais_alvo.baixo_di %}
                    {% set novo_total = obj.novos_valores.total %}
                    {% set target_reais = novo_total * target_pct / 100 %}
                    {% set novo_reais = obj.novos_valores.baixo_di %}
                    {% set gap = target_reais - novo_reais %}
                    
                    {% if novo_total > 0 %}
                        {% set novo_pct = (novo_reais / novo_total) * 100 %}
                    {% else %}
                        {% set novo_pct = 0 %}
                    {% endif %}
                    
                    <td class="text-center" style="background-color: #d4edda;">{{ '{:.1f}'.format(target_pct) }}%</td>
                    <td class="text-right" style="background-color: #d4edda;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                    <td class="text-center" style="background-color: {% if novo_pct < target_pct %}#fff3cd{% elif novo_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                        {{ '{:.1f}'.format(novo_pct) }}%
                    </td>
                    <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(novo_reais).replace(',', '.') }}</td>
                    <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                        {% if gap > 0 %}
                            <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% elif gap < 0 %}
                            <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            
            <!-- Linha: Baixo RFx -->
            <tr>
                <td style="background-color: #d4edda;"><strong> Baixo RFx</strong></td>
                {% for obj in resultado.resultados_por_objetivo %}
                    {% set target_pct = obj.percentuais_alvo.baixo_rfx %}
                    {% set novo_total = obj.novos_valores.total %}
                    {% set target_reais = novo_total * target_pct / 100 %}
                    {% set novo_reais = obj.novos_valores.baixo_rfx %}
                    {% set gap = target_reais - novo_reais %}
                    
                    {% if novo_total > 0 %}
                        {% set novo_pct = (novo_reais / novo_total) * 100 %}
                    {% else %}
                        {% set novo_pct = 0 %}
                    {% endif %}
                    
                    <td class="text-center" style="background-color: #d4edda;">{{ '{:.1f}'.format(target_pct) }}%</td>
                    <td class="text-right" style="background-color: #d4edda;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                    <td class="text-center" style="background-color: {% if novo_pct < target_pct %}#fff3cd{% elif novo_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                        {{ '{:.1f}'.format(novo_pct) }}%
                    </td>
                    <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(novo_reais).replace(',', '.') }}</td>
                    <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                        {% if gap > 0 %}
                            <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% elif gap < 0 %}
                            <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            
            <!-- Linha: Moderado -->
            <tr>
                <td style="background-color: #fff3cd;"><strong> Moderado</strong></td>
                {% for obj in resultado.resultados_por_objetivo %}
                    {% set target_pct = obj.percentuais_alvo.moderado %}
                    {% set novo_total = obj.novos_valores.total %}
                    {% set target_reais = novo_total * target_pct / 100 %}
                    {% set novo_reais = obj.novos_valores.moderado %}
                    {% set gap = target_reais - novo_reais %}
                    
                    {% if novo_total > 0 %}
                        {% set novo_pct = (novo_reais / novo_total) * 100 %}
                    {% else %}
                        {% set novo_pct = 0 %}
                    {% endif %}
                    
                    <td class="text-center" style="background-color: #fff3cd;">{{ '{:.1f}'.format(target_pct) }}%</td>
                    <td class="text-right" style="background-color: #fff3cd;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                    <td class="text-center" style="background-color: {% if novo_pct < target_pct %}#fff3cd{% elif novo_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                        {{ '{:.1f}'.format(novo_pct) }}%
                    </td>
                    <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(novo_reais).replace(',', '.') }}</td>
                    <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                        {% if gap > 0 %}
                            <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% elif gap < 0 %}
                            <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            
            <!-- Linha: Alto -->
            <tr>
                <td style="background-color: #f8d7da;"><strong> Alto</strong></td>
                {% for obj in resultado.resultados_por_objetivo %}
                    {% set target_pct = obj.percentuais_alvo.alto %}
                    {% set novo_total = obj.novos_valores.total %}
                    {% set target_reais = novo_total * target_pct / 100 %}
                    {% set novo_reais = obj.novos_valores.alto %}
                    {% set gap = target_reais - novo_reais %}
                    
                    {% if novo_total > 0 %}
                        {% set novo_pct = (novo_reais / novo_total) * 100 %}
                    {% else %}
                        {% set novo_pct = 0 %}
                    {% endif %}
                    
                    <td class="text-center" style="background-color: #f8d7da;">{{ '{:.1f}'.format(target_pct) }}%</td>
                    <td class="text-right" style="background-color: #f8d7da;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                    <td class="text-center" style="background-color: {% if novo_pct < target_pct %}#fff3cd{% elif novo_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                        {{ '{:.1f}'.format(novo_pct) }}%
                    </td>
                    <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(novo_reais).replace(',', '.') }}</td>
                    <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                        {% if gap > 0 %}
                            <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% elif gap < 0 %}
                            <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            
            <!-- Linha: Novo Total + Aporte -->
            <tr class="table-active">
                <td><strong>NOVO TOTAL</strong></td>
                {% for obj in resultado.resultados_por_objetivo %}
                    <td colspan="4" class="text-right"><strong>R$ {{ '{:,.0f}'.format(obj.novos_valores.total).replace(',', '.') }}</strong></td>
                    <td></td>
                {% endfor %}
            </tr>
            <tr class="table-primary">
                <td><strong>APORTE</strong></td>
                {% for obj in resultado.resultados_por_objetivo %}
                    <td colspan="5" class="text-center" style="background-color: #e7f3ff;">
                        <strong>R$ {{ '{:,.0f}'.format(obj.valor_aporte).replace(',', '.') }}</strong>
                    </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>
    </div>
    
    <div style="margin-top: 10px;">
        <small class="text-muted">
            <strong>Gap R$</strong> = DiferenÃ§a entre Target e Novo | 
            <span style="color: green;">Verde (+)</span> = Ainda precisa COMPRAR | 
            <span style="color: red;">Vermelho (-)</span> = Ainda precisa VENDER
        </small>
    </div>
    <p></p>
    <!-- RESUMO DO APORTE -->
    <div>
        <h3 >Resumo Consolidado</h3>
        
        <div style="max-width: 500px;">
                        
            {% set aporte_di = resultado.aportes_agregados.baixo_di %}
            {% set aporte_rfx = resultado.aportes_agregados.baixo_rfx %}
            {% set aporte_moderado = resultado.aportes_agregados.moderado %}
            {% set aporte_alto = resultado.aportes_agregados.alto %}
            {% set total_aporte = aporte_di + aporte_rfx + aporte_moderado + aporte_alto %}
            
            <table class="table table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th>Classe de Risco</th>
                        <th class="text-right">Valor Investido</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background-color: #d4edda;">
                        <td><strong>Baixo DI</strong></td>
                        <td class="text-right"><strong>R$ {{ '{:,.0f}'.format(aporte_di).replace(',', '.') }}</strong></td>
                    </tr>
                    <tr style="background-color: #d4edda;">
                        <td><strong>Baixo RFx</strong></td>
                        <td class="text-right"><strong>R$ {{ '{:,.0f}'.format(aporte_rfx).replace(',', '.') }}</strong></td>
                    </tr>
                    <tr style="background-color: #fff3cd;">
                        <td><strong>Moderado</strong></td>
                        <td class="text-right"><strong>R$ {{ '{:,.0f}'.format(aporte_moderado).replace(',', '.') }}</strong></td>
                    </tr>
                    <tr style="background-color: #f8d7da;">
                        <td><strong>Alto</strong></td>
                        <td class="text-right"><strong>R$ {{ '{:,.0f}'.format(aporte_alto).replace(',', '.') }}</strong></td>
                    </tr>
                    <tr style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #333;">
                        <td><strong>TOTAL</strong></td>
                        <td class="text-right"><strong>R$ {{ '{:,.0f}'.format(total_aporte).replace(',', '.') }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
<p></p>
    <div>{# TABELA DE FATIAS ALOCADAS  #}
    <h3 > Fatias Alocadas por Objetivo </h3>
        
    <div style="overflow-x: auto; margin-bottom: 30px;">
        <table class="table table-bordered table-sm" style="font-size: 0.85em; max-width: 800px;">
            <thead style="background-color: #f8f9fa;">
                <tr>
                    <th style="min-width: 120px;">Classe de Risco</th>
                    {% for obj in resultado.resultados_por_objetivo %}
                    <th class="text-center">{{ obj.objetivo_nome }}</th>
                    {% endfor %}
                    <th class="text-center" style="background-color: #e9ecef;"><strong>Total</strong></th>
                </tr>
            </thead>
            <tbody>
                {# Linha: Baixo DI #}
                <tr>
                    <td style="background-color: #d4edda;"><strong>Baixo DI</strong></td>
                    {% for obj in resultado.resultados_por_objetivo %}
                        {% set perc = obj.novos_percentuais.baixo_di %}
                        <td class="text-center" style="background-color: #d4edda;">
                            {% if perc > 0 %}
                                {{ '{:.1f}'.format(perc) }}%
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td class="text-center" style="background-color: #c3e6cb;"><strong>100%</strong></td>
                </tr>
                
                {# Linha: Baixo RFx #}
                <tr>
                    <td style="background-color: #d4edda;"><strong>Baixo RFx</strong></td>
                    {% for obj in resultado.resultados_por_objetivo %}
                        {% set perc = obj.novos_percentuais.baixo_rfx %}
                        <td class="text-center" style="background-color: #d4edda;">
                            {% if perc > 0 %}
                                {{ '{:.1f}'.format(perc) }}%
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td class="text-center" style="background-color: #c3e6cb;"><strong>100%</strong></td>
                </tr>
                
                {# Linha: Moderado #}
                <tr>
                    <td style="background-color: #fff3cd;"><strong>Moderado</strong></td>
                    {% for obj in resultado.resultados_por_objetivo %}
                        {% set perc = obj.novos_percentuais.moderado %}
                        <td class="text-center" style="background-color: #fff3cd;">
                            {% if perc > 0 %}
                                {{ '{:.1f}'.format(perc) }}%
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td class="text-center" style="background-color: #ffeaa7;"><strong>100%</strong></td>
                </tr>
                
                {# Linha: Alto #}
                <tr>
                    <td style="background-color: #f8d7da;"><strong>Alto</strong></td>
                    {% for obj in resultado.resultados_por_objetivo %}
                        {% set perc = obj.novos_percentuais.alto %}
                        <td class="text-center" style="background-color: #f8d7da;">
                            {% if perc > 0 %}
                                {{ '{:.1f}'.format(perc) }}%
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td class="text-center" style="background-color: #f5c6cb;"><strong>100%</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <hr style="margin: 30px 0;">
    
    <!-- AÃ§Ãµes Consolidadas -->
    <h3 > AÃ§Ãµes Recomendadas </h3>
    
    <div style="max-width: 600px;">
        <table class="table table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th style="width: 40%;">Classe de Risco</th>
                    <th class="text-center">AÃ§Ã£o Recomendada</th>
                    <th class="text-right" style="width: 25%;">Valor/Gap</th>
                </tr>
            </thead>
            <tbody>
                {% set acao_di = resultado.acoes_consolidadas.baixo_di %}
                <tr>
                    <td style="background-color: #d4edda;"><strong>Baixo DI</strong></td>
                    <td class="text-center" style="background-color: {% if acao_di.tipo == 'REDISTRIBUIR' %}#e3f2fd{% elif acao_di.tipo == 'COMPRAR' %}#d4edda{% else %}#f8d7da{% endif %};">
                        <strong>
                        {% if acao_di.tipo == 'REDISTRIBUIR' %}
                            âœ… REDISTRIBUIR
                        {% elif acao_di.tipo == 'COMPRAR' %}
                            ðŸŸ¢ COMPRAR
                        {% else %}
                            ðŸ”´ VENDER
                        {% endif %}
                        </strong>
                    </td>
                    <td class="text-right" style="background-color: {% if acao_di.tipo == 'REDISTRIBUIR' %}#e3f2fd{% elif acao_di.tipo == 'COMPRAR' %}#d4edda{% else %}#f8d7da{% endif %};">
                        {% if acao_di.tipo == 'REDISTRIBUIR' %}
                            <span style="font-size: 0.85em; color: #666;">Gap: R$ {{ '{:,.0f}'.format(acao_di.gap_total).replace(',', '.') }}</span>
                        {% else %}
                            <strong>R$ {{ '{:,.0f}'.format(acao_di.valor).replace(',', '.') }}</strong>
                        {% endif %}
                    </td>
                </tr>
                
                {% set acao_rfx = resultado.acoes_consolidadas.baixo_rfx %}
                <tr>
                    <td style="background-color: #d4edda;"><strong>Baixo RFx</strong></td>
                    <td class="text-center" style="background-color: {% if acao_rfx.tipo == 'REDISTRIBUIR' %}#e3f2fd{% elif acao_rfx.tipo == 'COMPRAR' %}#d4edda{% else %}#f8d7da{% endif %};">
                        <strong>
                        {% if acao_rfx.tipo == 'REDISTRIBUIR' %}
                            âœ… REDISTRIBUIR
                        {% elif acao_rfx.tipo == 'COMPRAR' %}
                            ðŸŸ¢ COMPRAR
                        {% else %}
                            ðŸ”´ VENDER
                        {% endif %}
                        </strong>
                    </td>
                    <td class="text-right" style="background-color: {% if acao_rfx.tipo == 'REDISTRIBUIR' %}#e3f2fd{% elif acao_rfx.tipo == 'COMPRAR' %}#d4edda{% else %}#f8d7da{% endif %};">
                        {% if acao_rfx.tipo == 'REDISTRIBUIR' %}
                            <span style="font-size: 0.85em; color: #666;">Gap: R$ {{ '{:,.0f}'.format(acao_rfx.gap_total).replace(',', '.') }}</span>
                        {% else %}
                            <strong>R$ {{ '{:,.0f}'.format(acao_rfx.valor).replace(',', '.') }}</strong>
                        {% endif %}
                    </td>
                </tr>
                
                {% set acao_mod = resultado.acoes_consolidadas.moderado %}
                <tr>
                    <td style="background-color: #fff3cd;"><strong>Moderado</strong></td>
                    <td class="text-center" style="background-color: {% if acao_mod.tipo == 'REDISTRIBUIR' %}#e3f2fd{% elif acao_mod.tipo == 'COMPRAR' %}#d4edda{% else %}#f8d7da{% endif %};">
                        <strong>
                        {% if acao_mod.tipo == 'REDISTRIBUIR' %}
                            âœ… REDISTRIBUIR
                        {% elif acao_mod.tipo == 'COMPRAR' %}
                            ðŸŸ¢ COMPRAR
                        {% else %}
                            ðŸ”´ VENDER
                        {% endif %}
                        </strong>
                    </td>
                    <td class="text-right" style="background-color: {% if acao_mod.tipo == 'REDISTRIBUIR' %}#e3f2fd{% elif acao_mod.tipo == 'COMPRAR' %}#d4edda{% else %}#f8d7da{% endif %};">
                        {% if acao_mod.tipo == 'REDISTRIBUIR' %}
                            <span style="font-size: 0.85em; color: #666;">Gap: R$ {{ '{:,.0f}'.format(acao_mod.gap_total).replace(',', '.') }}</span>
                        {% else %}
                            <strong>R$ {{ '{:,.0f}'.format(acao_mod.valor).replace(',', '.') }}</strong>
                        {% endif %}
                    </td>
                </tr>
                
                {% set acao_alto = resultado.acoes_consolidadas.alto %}
                <tr>
                    <td style="background-color: #f8d7da;"><strong>Alto</strong></td>
                    <td class="text-center" style="background-color: {% if acao_alto.tipo == 'REDISTRIBUIR' %}#e3f2fd{% elif acao_alto.tipo == 'COMPRAR' %}#d4edda{% else %}#f8d7da{% endif %};">
                        <strong>
                        {% if acao_alto.tipo == 'REDISTRIBUIR' %}
                            âœ… REDISTRIBUIR
                        {% elif acao_alto.tipo == 'COMPRAR' %}
                            ðŸŸ¢ COMPRAR
                        {% else %}
                            ðŸ”´ VENDER
                        {% endif %}
                        </strong>
                    </td>
                    <td class="text-right" style="background-color: {% if acao_alto.tipo == 'REDISTRIBUIR' %}#e3f2fd{% elif acao_alto.tipo == 'COMPRAR' %}#d4edda{% else %}#f8d7da{% endif %};">
                        {% if acao_alto.tipo == 'REDISTRIBUIR' %}
                            <span style="font-size: 0.85em; color: #666;">Gap: R$ {{ '{:,.0f}'.format(acao_alto.gap_total).replace(',', '.') }}</span>
                        {% else %}
                            <strong>R$ {{ '{:,.0f}'.format(acao_alto.valor).replace(',', '.') }}</strong>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

</div>
    <p></p>
    <!-- BotÃµes de AÃ§Ã£o -->
    <div>
        <form method="POST" action="{{ url_for('balanco.aplicar', cliente_id=cliente.id) }}" style="display: inline;">
            <button type="submit" class="bigBtn"  onclick="return confirm('Confirma aplicaÃ§Ã£o? Os percentuais e valores serÃ£o salvos.')">
                <img src="{{ url_for('static', filename='icons/save.png') }}" class="btn-icon" >
                Aplicar e Salvar
            </button>
        </form>
        
        <form method="POST" action="{{ url_for('balanco.descartar', cliente_id=cliente.id) }}" style="display: inline;">
            <button type="submit" class="bigBtn" >
                <img src="{{ url_for('static', filename='icons/discard.png') }}" class="btn-icon" >
                Descartar
            </button>
        </form>
        
        <button type="button" class="smlBtn" onclick="window.location.href='{{ url_for('balanco.iniciar', cliente_id=cliente.id) }}'">
            <img src="{{ url_for('static', filename='icons/back.png') }}" class="sml-btn-icon">
        </button>
    </div>

</div>

<style>
.table {
    font-size: 0.8em;
}
.table th, .table td {
    padding: 5px;
    white-space: nowrap;
}
</style>
{% endblock %}