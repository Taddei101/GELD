{% extends "base.html" %}

{% block title %}Distribuição de Capital{% endblock %}
{% block header %}Distribuição de Capital para {{cliente.nome}} {% endblock %}
{% block content %}

<!-- Definindo macro para formatação de valores monetários -->
{% macro format_valor(valor) %}
    {{ '{:,.2f}'.format(valor).replace(',', ' ').replace('.', ',').replace(' ', '.') }}
{% endmacro %}

<!-- Macro para formatar percentuais -->
{% macro format_percentual(valor) %}
    {{ '{:.1f}'.format(valor) }}%
{% endmacro %}

<h3>Sumário</h3>
<table class="table">
    <thead>
        <tr>
            <th>Capital Total</th>
            <th>Capital Alocado</th>
            <th>Percentual Alocado</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>R$ {{ format_valor(resultado.sumario.total_disponivel) }}</td>
            <td>R$ {{ format_valor(resultado.sumario.total_alocado) }}</td>
            <td>{{ resultado.sumario.percentual_alocado }}%</td>
        </tr>
    </tbody>
</table>

<h3>Distribuição por Risco</h3>
<table class="table">
    <thead>
        <tr>
            <th>Risco Baixo</th>
            <th>Risco Moderado</th>
            <th>Risco Alto</th>
            <th>Fundo DI</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
                R$ {{ format_valor(resultado.total_por_risco.baixo) }}
                <div class="progress-bar-container">
                    <div class="progress-bar-vertical">
                        <div class="progress-fill" style="height: {{ resultado.total_por_risco.baixo / resultado.sumario.total_disponivel * 100 }}%;">
                        </div>
                        <span class="percentage-text">{{ '{:.1f}'.format(resultado.total_por_risco.baixo / resultado.sumario.total_disponivel * 100) }}%</span>
                    </div>
                </div>
            </td>
            <td>
                R$ {{ format_valor(resultado.total_por_risco.moderado) }}
                <div class="progress-bar-container">
                    <div class="progress-bar-vertical">
                        <div class="progress-fill" style="height: {{ resultado.total_por_risco.moderado / resultado.sumario.total_disponivel * 100 }}%;">
                        </div>
                        <span class="percentage-text">{{ '{:.1f}'.format(resultado.total_por_risco.moderado / resultado.sumario.total_disponivel * 100) }}%</span>
                    </div>
                </div>
            </td>
            <td>
                R$ {{ format_valor(resultado.total_por_risco.alto) }}
                <div class="progress-bar-container">
                    <div class="progress-bar-vertical">
                        <div class="progress-fill" style="height: {{ resultado.total_por_risco.alto / resultado.sumario.total_disponivel * 100 }}%;">
                        </div>
                        <span class="percentage-text">{{ '{:.1f}'.format(resultado.total_por_risco.alto / resultado.sumario.total_disponivel * 100) }}%</span>
                    </div>
                </div>
            </td>
            <td>
                R$ {{ format_valor(resultado.total_por_risco.fundo_DI) }}
                <div class="progress-bar-container">
                    <div class="progress-bar-vertical">
                        <div class="progress-fill" style="height: {{ resultado.total_por_risco.fundo_DI / resultado.sumario.total_disponivel * 100 }}%;">
                        </div>
                        <span class="percentage-text">{{ '{:.1f}'.format(resultado.total_por_risco.fundo_DI / resultado.sumario.total_disponivel * 100) }}%</span>
                    </div>
                </div>
            </td>
        </tr>
    </tbody>
</table>

<h3>Distribuição por Objetivo</h3>
<table class="table">
    <thead>
        <tr>
            <th>Objetivo</th>
            <th>Prazo (meses)</th>
            <th>Valor Alvo</th>
            <th>Valor Alocado</th>
            <th>Progresso</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for objetivo_id, objetivo in resultado.alocacao_por_objetivo.items() %}
        <tr>
            <td>{{ objetivo.nome }}</td>
            <td>{{ objetivo.prazo_meses }}</td>
            <td>R$ {{ format_valor(objetivo.valor_alvo) }}</td>
            <td>R$ {{ format_valor(objetivo.alocacao_total) }}</td>
            <td>
                <div class="progress-bar-container">
                    <div class="progress-bar-vertical">
                        <div class="progress-fill" style="height: {{ objetivo.percentual_atingido }}%;">
                        </div>
                        <span class="percentage-text">{{ objetivo.percentual_atingido }}%</span>
                    </div>
                </div>
            </td>
            <td>
                <button title="Ver Detalhes" class="smlBtn" onclick="toggleDetails('detalhe-{{ objetivo_id }}')">
                    <img src="{{ url_for('static', filename='icons/lupa.png') }}" class="sml-btn-icon">
                </button>
            </td>
        </tr>
        <tr id="detalhe-{{ objetivo_id }}" style="display: none;">
            <td colspan="6">
                <div class="info-card">
                    <h4>Distribuição por Risco</h4>
                    
                    <!-- Determinando o perfil ideal baseado no prazo do objetivo -->
                    {% set prazo = objetivo.prazo_meses %}
                    {% if prazo <= 12 %}
                        {% set perfil_ideal = {'baixo': 80, 'moderado': 15, 'alto': 5, 'fundo_DI': 0} %}
                    {% elif prazo <= 36 %}
                        {% set perfil_ideal = {'baixo': 50, 'moderado': 35, 'alto': 15, 'fundo_DI': 0} %}
                    {% elif prazo <= 60 %}
                        {% set perfil_ideal = {'baixo': 30, 'moderado': 40, 'alto': 30, 'fundo_DI': 0} %}
                    {% else %}
                        {% set perfil_ideal = {'baixo': 15, 'moderado': 35, 'alto': 50, 'fundo_DI': 0} %}
                    {% endif %}
                    
                    <!-- Calculando os percentuais reais de cada risco (se houver alocação total) -->
                    {% if objetivo.alocacao_total > 0 %}
                        {% set pct_baixo = objetivo.alocacao_por_risco.baixo / objetivo.alocacao_total * 100 %}
                        {% set pct_moderado = objetivo.alocacao_por_risco.moderado / objetivo.alocacao_total * 100 %}
                        {% set pct_alto = objetivo.alocacao_por_risco.alto / objetivo.alocacao_total * 100 %}
                        {% set pct_fundo_DI = objetivo.alocacao_por_risco.fundo_DI / objetivo.alocacao_total * 100 %}
                    {% else %}
                        {% set pct_baixo = 0 %}
                        {% set pct_moderado = 0 %}
                        {% set pct_alto = 0 %}
                        {% set pct_fundo_DI = 0 %}
                    {% endif %}
                    
                    <table class="info-table" style="width: 100%;">
                        <tr>
                            <th></th>
                            <th>Risco Baixo</th>
                            <th>Risco Moderado</th>
                            <th>Risco Alto</th>
                            <th>Fundo DI</th>
                        </tr>
                        <tr>
                            <th>Valor</th>
                            <td>R$ {{ format_valor(objetivo.alocacao_por_risco.baixo) }}</td>
                            <td>R$ {{ format_valor(objetivo.alocacao_por_risco.moderado) }}</td>
                            <td>R$ {{ format_valor(objetivo.alocacao_por_risco.alto) }}</td>
                            <td>R$ {{ format_valor(objetivo.alocacao_por_risco.fundo_DI) }}</td>
                        </tr>
                        <tr>
                            <th>Distribuição Real</th>
                            <td>{{ format_percentual(pct_baixo) }}</td>
                            <td>{{ format_percentual(pct_moderado) }}</td>
                            <td>{{ format_percentual(pct_alto) }}</td>
                            <td>{{ format_percentual(pct_fundo_DI) }}</td>
                        </tr>
                        <tr>
                            <th>Distribuição Ideal</th>
                            <td>{{ perfil_ideal.baixo }}%</td>
                            <td>{{ perfil_ideal.moderado }}%</td>
                            <td>{{ perfil_ideal.alto }}%</td>
                            <td>{{ perfil_ideal.fundo_DI }}%</td>
                        </tr>
                        <tr>
                            <th>Diferença</th>
                            <td class="{{ 'text-success' if (pct_baixo - perfil_ideal.baixo)|abs < 5 else 'text-danger' }}">
                                {% if pct_baixo > perfil_ideal.baixo %}+{% endif %}{{ format_percentual(pct_baixo - perfil_ideal.baixo) }}
                            </td>
                            <td class="{{ 'text-success' if (pct_moderado - perfil_ideal.moderado)|abs < 5 else 'text-danger' }}">
                                {% if pct_moderado > perfil_ideal.moderado %}+{% endif %}{{ format_percentual(pct_moderado - perfil_ideal.moderado) }}
                            </td>
                            <td class="{{ 'text-success' if (pct_alto - perfil_ideal.alto)|abs < 5 else 'text-danger' }}">
                                {% if pct_alto > perfil_ideal.alto %}+{% endif %}{{ format_percentual(pct_alto - perfil_ideal.alto) }}
                            </td>
                            <td class="{{ 'text-success' if (pct_fundo_DI - perfil_ideal.fundo_DI)|abs < 5 else 'text-danger' }}">
                                {% if pct_fundo_DI > perfil_ideal.fundo_DI %}+{% endif %}{{ format_percentual(pct_fundo_DI - perfil_ideal.fundo_DI) }}
                            </td>
                        </tr>
                    </table>
                    
                    {% if objetivo.alocacao_por_investimento %}
                    <h4>Investimentos Alocados</h4>
                    <table class="info-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Fundo</th>
                                <th>Risco</th>
                                <th>Valor Alocado</th>
                                <th>Cotas Alocadas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for inv in objetivo.alocacao_por_investimento %}
                            <tr>
                                <td>{{ inv.nome_fundo }}</td>
                                <td>{{ inv.risco.capitalize() }}</td>
                                <td>R$ {{ format_valor(inv.valor_alocado) }}</td>
                                <td>{{ '{:,.6f}'.format(inv.cotas_alocadas).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p>Este objetivo não recebeu alocação de capital.</p>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if resultado.objetivos_nao_atendidos %}
<h3>Objetivos Não Totalmente Atendidos</h3>
<table class="table">
    <thead>
        <tr>
            <th>Objetivo</th>
            <th>Valor Alocado</th>
            <th>Valor Alvo</th>
            <th>Percentual Atingido</th>
            <th>Valor Faltante</th>
        </tr>
    </thead>
    <tbody>
        {% for objetivo in resultado.objetivos_nao_atendidos %}
        <tr>
            <td>{{ objetivo.nome }}</td>
            <td>R$ {{ format_valor(objetivo.valor_alocado) }}</td>
            <td>R$ {{ format_valor(objetivo.valor_alvo) }}</td>
            <td>{{ objetivo.percentual_atingido }}%</td>
            <td>R$ {{ format_valor(objetivo.valor_faltante) }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if resultado.capital_nao_alocado > 0 %}
<h3>Capital Não Alocado</h3>
<p>R$ {{ format_valor(resultado.capital_nao_alocado) }}</p>
<p>Este valor representa o capital que não foi alocado para nenhum objetivo, seja porque todos os objetivos já foram atingidos ou porque o perfil de risco dos investimentos disponíveis não corresponde às necessidades dos objetivos restantes.</p>
{% endif %}
<p></p>
<div class="mt-4">
    <button title="Aplicar Alocação" class="smlBtn" onclick="confirmarAtualizacao()">
        <img src="{{ url_for('static', filename='icons/save.png') }}" class="sml-btn-icon">
    </button>
    
    <button title="Voltar" class="smlBtn" onclick="window.location.href=`{{url_for('cliente.area_cliente', cliente_id=cliente.id) }}`">
        <img src="{{ url_for('static', filename='icons/back.png') }}" class="sml-btn-icon">
    </button>
</div>

<script>
function toggleDetails(id) {
    var element = document.getElementById(id);
    if (element.style.display === "none") {
        element.style.display = "table-row";
    } else {
        element.style.display = "none";
    }
}

function confirmarAtualizacao() {
    if (confirm("Confirma a aplicação desta alocação? Isso atualizará o valor real de todos os objetivos.")) {
        window.location.href = "{{ url_for('distribuicao.aplicar_alocacao', cliente_id=cliente.id) }}";
    }
}
</script>
{% endblock %}