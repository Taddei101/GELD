{% extends "base.html" %}

{% block title %} Profile - Geld's Finance {% endblock %}

{% block header %} {{cliente.nome}} {% endblock %}

{% block content %}

<!-- CONTAINER: Resumo por Classe de Risco + Fatias lado a lado -->
{% if has_positions or objetivos %}
<div style="display: flex; flex-wrap: nowrap; gap: 20px; align-items: stretch; overflow-x: auto;">

    <!-- SEÇÃO: Resumo por Classe de Risco (Detalhado) -->
    {% if has_positions %}
    <div class="client_area" style="flex: 0 0 auto;">
        <h3>Resumo por Classe de Risco</h3>
        <table class="table" >
        <thead>
            <tr>
                <th style="min-width: 120px;white-space: nowrap;">Classe de Risco</th>
                <th style="min-width: 160px; white-space: nowrap;">Saldo Atual</th>
                <th style="min-width: 100px; white-space: nowrap;">% do Portfolio</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Baixo DI</td>
                <td>R$ {{ '{:,.2f}'.format(saldo_fundo_di if saldo_fundo_di is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>{{ '{:.1f}%'.format((saldo_fundo_di / montante_cliente * 100) if montante_cliente > 0 and saldo_fundo_di is defined else 0).replace('.', ',') }}</td>
            </tr>
            <tr>
                <td>Baixo RFx</td>
                <td>R$ {{ '{:,.2f}'.format(saldo_baixo if saldo_baixo is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>{{ '{:.1f}%'.format((saldo_baixo / montante_cliente * 100) if montante_cliente > 0 and saldo_baixo is defined else 0).replace('.', ',') }}</td>
            </tr>
            <tr>
                <td>Moderado</td>
                <td>R$ {{ '{:,.2f}'.format(saldo_moderado if saldo_moderado is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>{{ '{:.1f}%'.format((saldo_moderado / montante_cliente * 100) if montante_cliente > 0 and saldo_moderado is defined else 0).replace('.', ',') }}</td>
            </tr>
            <tr>
                <td>Alto</td>
                <td>R$ {{ '{:,.2f}'.format(saldo_alto if saldo_alto is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>{{ '{:.1f}%'.format((saldo_alto / montante_cliente * 100) if montante_cliente > 0 and saldo_alto is defined else 0).replace('.', ',') }}</td>
            </tr>
            <tr class="total-row">
                <td>Total</td>
                <td>R$ {{ '{:,.2f}'.format(montante_cliente).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>100,0%</td>
            </tr>
        </tbody>
        </table>
    </div>
    {% endif %}

    <!-- TABELA: Fatias Alocadas por Objetivo -->
    {% if objetivos %}
    <div class="client_area" style="flex: 0 0 auto;">
        <h3>Fatias Alocadas por Objetivo</h3>
        <div style="overflow-x: auto; margin-bottom: 30px;">
            <table class="table">
                <thead style="background-color: #f8f9fa;">
                    <tr>
                        <th style="min-width: 120px; white-space: nowrap;">Classe de Risco</th>
                        {% for objetivo in objetivos %}
                        <th class="text-center" style="white-space: nowrap;">{{ objetivo.nome_objetivo }}</th>
                        {% endfor %}
                        <th class="text-center" style="background-color: #e9ecef; white-space: nowrap;"><strong>Total</strong></th>
                    </tr>
                </thead>
                <tbody>
                    {#Linha valor desejado#}
                    <tr>
                        <td><strong>Valor Desejado</strong></td>
                        {% for objetivo in objetivos %}
                            <td class="text-center" style="white-space: nowrap;">
                                R$ {{ '{:,.0f}'.format(objetivo.valor_final | float).replace(',', '.') }}
                            </td>
                        {% endfor %}
                        <td><img src="{{ url_for('static', filename='icons/pie.png') }}" class="sml-btn-icon"></td>
                    </tr>
                    {# Linha: Baixo DI #}
                    <tr>
                        <td style="background-color: #d4edda;"><strong>Baixo DI</strong></td>
                        {% for objetivo in objetivos %}
                            {% set perc = percentuais_salvos[objetivo.id].baixo_di %}
                            <td class="text-center" style="background-color: #d4edda;">
                                {% if perc > 0 %}
                                    {{ '{:.1f}'.format(perc) }}%
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                        {% endfor %}
                        <td class="text-center" style="background-color: #c3e6cb;"><strong>100%</strong></td>
                    </tr>

                    {# Linha: Baixo RFx #}
                    <tr>
                        <td style="background-color: #d4edda;"><strong>Baixo RFx</strong></td>
                        {% for objetivo in objetivos %}
                            {% set perc = percentuais_salvos[objetivo.id].baixo_rfx %}
                            <td class="text-center" style="background-color: #d4edda;">
                                {% if perc > 0 %}
                                    {{ '{:.1f}'.format(perc) }}%
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                        {% endfor %}
                        <td class="text-center" style="background-color: #c3e6cb;"><strong>100%</strong></td>
                    </tr>

                    {# Linha: Moderado #}
                    <tr>
                        <td style="background-color: #fff3cd;"><strong>Moderado</strong></td>
                        {% for objetivo in objetivos %}
                            {% set perc = percentuais_salvos[objetivo.id].moderado %}
                            <td class="text-center" style="background-color: #fff3cd;">
                                {% if perc > 0 %}
                                    {{ '{:.1f}'.format(perc) }}%
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                        {% endfor %}
                        <td class="text-center" style="background-color: #ffeaa7;"><strong>100%</strong></td>
                    </tr>

                    {# Linha: Alto #}
                    <tr>
                        <td style="background-color: #f8d7da;"><strong>Alto</strong></td>
                        {% for objetivo in objetivos %}
                            {% set perc = percentuais_salvos[objetivo.id].alto %}
                            <td class="text-center" style="background-color: #f8d7da;">
                                {% if perc > 0 %}
                                    {{ '{:.1f}'.format(perc) }}%
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                        {% endfor %}
                        <td class="text-center" style="background-color: #f5c6cb;"><strong>100%</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

</div>{# fecha container flex #}
{% endif %}

<p></p>

<!-- TABELA: Alocação por Objetivo -->
{% if objetivos %}
<div class="client_area">
    <h3> Alocação por Objetivo</h3>
    
    <div style="overflow-x: auto;">
    <table class="table">
        <thead>
            <tr>
                <th rowspan="2" style="vertical-align: middle; min-width: 120px;">Classe de Risco</th>
                {% for objetivo in objetivos %}
                <th colspan="5" class="text-center">
                    {{ objetivo.nome_objetivo }} ({{ objetivo.duracao_meses }}m)
                </th>
                {% endfor %}
            </tr>
            <tr style="font-size: 0.75em;">
                {% for objetivo in objetivos %}
                <th class="text-center">Tgt %</th>
                <th class="text-center">Tgt R$</th>
                <th class="text-center">Atual %</th>
                <th class="text-center">Atual R$</th>
                <th class="text-center">Gap R$</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <!-- Linha: Baixo DI -->
            <tr>
                <td style="background-color: #d4edda;"><strong> Baixo DI</strong></td>
                {% for objetivo in objetivos %}
                    {% set valores = valores_por_objetivo[objetivo.id] %}
                    {% set matriz = matrizes_risco[objetivo.id] %}
                    {% set total_atual = valores.total %}
                    
                    {% set target_pct = (matriz.perc_baixo * matriz.perc_di_dentro_baixo) / 100 %}
                    {% set target_reais = total_atual * target_pct / 100 %}
                    {% set atual_reais = valores.baixo_di %}
                    {% set gap = target_reais - atual_reais %}
                    
                    {% if total_atual > 0 %}
                        {% set atual_pct = (atual_reais / total_atual) * 100 %}
                    {% else %}
                        {% set atual_pct = 0 %}
                    {% endif %}
                    
                    <td class="text-center" style="background-color: #d4edda;">{{ '{:.1f}'.format(target_pct) }}%</td>
                    <td class="text-right" style="background-color: #d4edda;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                    <td class="text-center" style="background-color: {% if atual_pct < target_pct %}#fff3cd{% elif atual_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                        {{ '{:.1f}'.format(atual_pct) }}%
                    </td>
                    <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(atual_reais).replace(',', '.') }}</td>
                    <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                        {% if gap > 0 %}
                            <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% elif gap < 0 %}
                            <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            
            <!-- Linha: Baixo RFx -->
            <tr>
                <td style="background-color: #d4edda;"><strong> Baixo RFx</strong></td>
                {% for objetivo in objetivos %}
                    {% set valores = valores_por_objetivo[objetivo.id] %}
                    {% set matriz = matrizes_risco[objetivo.id] %}
                    {% set total_atual = valores.total %}
                    
                    {% set target_pct = (matriz.perc_baixo * matriz.perc_rfx_dentro_baixo) / 100 %}
                    {% set target_reais = total_atual * target_pct / 100 %}
                    {% set atual_reais = valores.baixo_rfx %}
                    {% set gap = target_reais - atual_reais %}
                    
                    {% if total_atual > 0 %}
                        {% set atual_pct = (atual_reais / total_atual) * 100 %}
                    {% else %}
                        {% set atual_pct = 0 %}
                    {% endif %}
                    
                    <td class="text-center" style="background-color: #d4edda;">{{ '{:.1f}'.format(target_pct) }}%</td>
                    <td class="text-right" style="background-color: #d4edda;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                    <td class="text-center" style="background-color: {% if atual_pct < target_pct %}#fff3cd{% elif atual_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                        {{ '{:.1f}'.format(atual_pct) }}%
                    </td>
                    <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(atual_reais).replace(',', '.') }}</td>
                    <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                        {% if gap > 0 %}
                            <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% elif gap < 0 %}
                            <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            
            <!-- Linha: Moderado -->
            <tr>
                <td style="background-color: #fff3cd;"><strong> Moderado</strong></td>
                {% for objetivo in objetivos %}
                    {% set valores = valores_por_objetivo[objetivo.id] %}
                    {% set matriz = matrizes_risco[objetivo.id] %}
                    {% set total_atual = valores.total %}
                    
                    {% set target_pct = matriz.perc_moderado %}
                    {% set target_reais = total_atual * target_pct / 100 %}
                    {% set atual_reais = valores.moderado %}
                    {% set gap = target_reais - atual_reais %}
                    
                    {% if total_atual > 0 %}
                        {% set atual_pct = (atual_reais / total_atual) * 100 %}
                    {% else %}
                        {% set atual_pct = 0 %}
                    {% endif %}
                    
                    <td class="text-center" style="background-color: #fff3cd;">{{ '{:.1f}'.format(target_pct) }}%</td>
                    <td class="text-right" style="background-color: #fff3cd;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                    <td class="text-center" style="background-color: {% if atual_pct < target_pct %}#fff3cd{% elif atual_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                        {{ '{:.1f}'.format(atual_pct) }}%
                    </td>
                    <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(atual_reais).replace(',', '.') }}</td>
                    <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                        {% if gap > 0 %}
                            <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% elif gap < 0 %}
                            <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            
            <!-- Linha: Alto -->
            <tr>
                <td style="background-color: #f8d7da;"><strong> Alto</strong></td>
                {% for objetivo in objetivos %}
                    {% set valores = valores_por_objetivo[objetivo.id] %}
                    {% set matriz = matrizes_risco[objetivo.id] %}
                    {% set total_atual = valores.total %}
                    
                    {% set target_pct = matriz.perc_alto %}
                    {% set target_reais = total_atual * target_pct / 100 %}
                    {% set atual_reais = valores.alto %}
                    {% set gap = target_reais - atual_reais %}
                    
                    {% if total_atual > 0 %}
                        {% set atual_pct = (atual_reais / total_atual) * 100 %}
                    {% else %}
                        {% set atual_pct = 0 %}
                    {% endif %}
                    
                    <td class="text-center" style="background-color: #f8d7da;">{{ '{:.1f}'.format(target_pct) }}%</td>
                    <td class="text-right" style="background-color: #f8d7da;">{{ '{:,.0f}'.format(target_reais).replace(',', '.') }}</td>
                    <td class="text-center" style="background-color: {% if atual_pct < target_pct %}#fff3cd{% elif atual_pct > target_pct %}#f8d7da{% else %}#d4edda{% endif %};">
                        {{ '{:.1f}'.format(atual_pct) }}%
                    </td>
                    <td class="text-right" style="background-color: #f8f9fa;">{{ '{:,.0f}'.format(atual_reais).replace(',', '.') }}</td>
                    <td class="text-right" style="background-color: {% if gap > 0 %}#d4edda{% elif gap < 0 %}#f8d7da{% else %}#f8f9fa{% endif %}; font-weight: bold;">
                        {% if gap > 0 %}
                            <span style="color: green;">+{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% elif gap < 0 %}
                            <span style="color: red;">{{ '{:,.0f}'.format(gap).replace(',', '.') }}</span>
                        {% else %}
                            0
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            
            <!-- Linha: Total Atual -->
            <tr class="table-active">
                <td><strong>TOTAL ATUAL</strong></td>
                {% for objetivo in objetivos %}
                    {% set valores = valores_por_objetivo[objetivo.id] %}
                    <td colspan="5" class="text-right"><strong>R$ {{ '{:,.0f}'.format(valores.total).replace(',', '.') }}</strong></td>
                {% endfor %}
            </tr>
        </tbody>
    </table>
    </div>
</div>
{% endif %}

<p></p>

<div class="client_area">
    <button class="bigBtn" onclick="window.location.href=`{{ url_for('cliente.info_cliente',cliente_id=cliente.id) }}`">
    <img src="{{ url_for('static', filename='icons/profile.png') }}" class="btn-icon">Informações Pessoais</button>
    
    <!-- Objetivos Financeiros -->
    <button class="bigBtn {% if not objetivos %}btn-orfao{% endif %}"
        title="{% if not objetivos %}Nenhum objetivo cadastrado. Clique para adicionar.{% endif %}"
        onclick="window.location.href=`{{ url_for('objetivo.listar_objetivos',cliente_id=cliente.id) }}`">
        <img src="{{ url_for('static', filename='icons/objetivo.png') }}" class="btn-icon">Objetivos Financeiros</button>
       
    <!-- Posição Financeira -->
    <button class="bigBtn {% if not has_positions %}btn-orfao{% endif %}"
        title="{% if not has_positions %}Nenhuma posição cadastrada. Clique para adicionar.{% endif %}"
        onclick="window.location.href=`{{ url_for('posicao.listar_posicao',cliente_id=cliente.id) }}`">
        <img src="{{ url_for('static', filename='icons/posicao.png') }}" class="btn-icon">Posição Financeira</button>

    <button class="bigBtn" onclick="window.location.href=`{{ url_for('balanco.iniciar', cliente_id=cliente.id) }}`">
        <img src="{{ url_for('static', filename='icons/balance.png') }}" class="btn-icon">Balancear Aporte</button>

    {% if tem_capital_orfao %}
    <button class="bigBtn btn-orfao" onclick="window.location.href=`{{ url_for('balanco.editar_fatias', cliente_id=cliente.id) }}`"
        title="Há capital não alocado em objetivos. Clique para definir as fatias.">
        <img src="{{ url_for('static', filename='icons/pie.png') }}" class="btn-icon"> Editar Fatias</button>
    {% else %}
    <button class="bigBtn" onclick="window.location.href=`{{ url_for('balanco.editar_fatias', cliente_id=cliente.id) }}`">
        <img src="{{ url_for('static', filename='icons/pie.png') }}" class="btn-icon">Editar Fatias</button>
    {% endif %}
    
    <form method="POST" action="{{ url_for('balanco.resetar_distribuicao', cliente_id=cliente.id) }}" style="display: inline;">
        <button type="submit" class="bigBtn" style="background-color: #6c757d;" onclick="return confirm('Resetar TODOS os percentuais de distribuição?')">
            <img src="{{ url_for('static', filename='icons/trash.png') }}" class="btn-icon" style="filter: brightness(0) invert(1);">Resetar Distribuição
        </button>
    </form>
</div>

<p></p>
<button title="Voltar" class="smlBtn" onclick="window.location.href=`{{ url_for('cliente.listar_clientes') }}`">
    <img src="{{ url_for('static', filename='icons/back.png') }}" class="sml-btn-icon"></button>
    
{% endblock %}