{% extends "base.html" %}

{% block title %} Profile - Geld's Finance {% endblock %}

{% block header %} {{cliente.nome}} {% endblock %}

{% block content %}
<div class="client_area">
    <table class="table">
        <tr>
            <th>Montante sob Gestão</th>
            <th>Objetivos</th>
            <th>Fundos em subscrição</th>
        </tr>
    </tbody>
    <tbody>
        <tr>
            <td>R$ {{ '{:,.2f}'.format(montante_cliente).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
            <td>{{n_objetivos}}</td>
            <td>{{n_fundos}}</td>
        </tr>
    </tbody>
    </table>
</div>

<p></p>

<!-- SEÇÃO: Resumo por Classe de Risco (Detalhado) -->
{% if has_positions %}
<div class="client_area">
    <h3>Resumo por Classe de Risco</h3>
    <table class="table">
    <thead>
        <tr>
            <th>Classe de Risco</th>
            <th>Saldo Atual</th>
            <th>% do Portfolio</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Baixo DI</td>
            <td>R$ {{ '{:,.2f}'.format(saldo_fundo_di if saldo_fundo_di is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
            <td>{{ '{:.1f}%'.format((saldo_fundo_di / montante_cliente * 100) if montante_cliente > 0 and saldo_fundo_di is defined else 0).replace('.', ',') }}</td>
        </tr>
        <tr>
            <td>Baixo RFx</td>
            <td>R$ {{ '{:,.2f}'.format(saldo_baixo if saldo_baixo is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
            <td>{{ '{:.1f}%'.format((saldo_baixo / montante_cliente * 100) if montante_cliente > 0 and saldo_baixo is defined else 0).replace('.', ',') }}</td>
        </tr>
        <tr>
            <td>Moderado</td>
            <td>R$ {{ '{:,.2f}'.format(saldo_moderado if saldo_moderado is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
            <td>{{ '{:.1f}%'.format((saldo_moderado / montante_cliente * 100) if montante_cliente > 0 and saldo_moderado is defined else 0).replace('.', ',') }}</td>
        </tr>
        <tr>
            <td>Alto</td>
            <td>R$ {{ '{:,.2f}'.format(saldo_alto if saldo_alto is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
            <td>{{ '{:.1f}%'.format((saldo_alto / montante_cliente * 100) if montante_cliente > 0 and saldo_alto is defined else 0).replace('.', ',') }}</td>
        </tr>
        <tr class="total-row" style="font-weight: bold; border-top: 2px solid #333;">
            <td>TOTAL GERAL</td>
            <td>R$ {{ '{:,.2f}'.format(montante_cliente).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
            <td>100,0%</td>
        </tr>
    </tbody>
    </table>
</div>

<p></p>

<!-- SEÇÃO: Ações Necessárias Pós-Aporte (se houver) -->
{% if acoes_necessarias is defined and acoes_necessarias %}
<div class="client_area">
    <h3>⚠️ Ações Necessárias - Balanceamento Aplicado</h3>
    <div class="alert alert-info">
        <p><strong>Último balanceamento aplicado em:</strong> {{ acoes_necessarias.data_aplicacao }}</p>
        <p><strong>Total aportado:</strong> R$ {{ '{:,.2f}'.format(acoes_necessarias.total_aporte).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</p>
    </div>
    
    <table class="table table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>Classe</th>
                <th>Tinha</th>
                <th>Aporte</th>
                <th>Deve Ter</th>
                <th>Ação</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td> <strong>Baixo DI</strong></td>
                <td>R$ {{ '{:,.2f}'.format(acoes_necessarias.antes.baixo_di).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td class="text-primary">+R$ {{ '{:,.2f}'.format(acoes_necessarias.aportes.baixo_di).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>R$ {{ '{:,.2f}'.format(acoes_necessarias.depois.baixo_di).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>
                    {% if acoes_necessarias.aportes.baixo_di > 0 %}
                        <span class="badge badge-success">✅ COMPRAR R$ {{ '{:,.2f}'.format(acoes_necessarias.aportes.baixo_di).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</span>
                    {% else %}
                        <span class="badge badge-secondary">-</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td> <strong>Baixo RFx</strong></td>
                <td>R$ {{ '{:,.2f}'.format(acoes_necessarias.antes.baixo_rfx).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td class="text-primary">+R$ {{ '{:,.2f}'.format(acoes_necessarias.aportes.baixo_rfx).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>R$ {{ '{:,.2f}'.format(acoes_necessarias.depois.baixo_rfx).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>
                    {% if acoes_necessarias.aportes.baixo_rfx > 0 %}
                        <span class="badge badge-success">✅ COMPRAR R$ {{ '{:,.2f}'.format(acoes_necessarias.aportes.baixo_rfx).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</span>
                    {% else %}
                        <span class="badge badge-secondary">-</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td> <strong>Moderado</strong></td>
                <td>R$ {{ '{:,.2f}'.format(acoes_necessarias.antes.moderado).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td class="text-primary">+R$ {{ '{:,.2f}'.format(acoes_necessarias.aportes.moderado).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>R$ {{ '{:,.2f}'.format(acoes_necessarias.depois.moderado).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>
                    {% if acoes_necessarias.aportes.moderado > 0 %}
                        <span class="badge badge-success">✅ COMPRAR R$ {{ '{:,.2f}'.format(acoes_necessarias.aportes.moderado).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</span>
                    {% else %}
                        <span class="badge badge-secondary">-</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td> <strong>Alto</strong></td>
                <td>R$ {{ '{:,.2f}'.format(acoes_necessarias.antes.alto).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td class="text-primary">+R$ {{ '{:,.2f}'.format(acoes_necessarias.aportes.alto).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>R$ {{ '{:,.2f}'.format(acoes_necessarias.depois.alto).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>
                    {% if acoes_necessarias.aportes.alto > 0 %}
                        <span class="badge badge-success">✅ COMPRAR R$ {{ '{:,.2f}'.format(acoes_necessarias.aportes.alto).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</span>
                    {% else %}
                        <span class="badge badge-secondary">-</span>
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>
    
    <div class="text-right">
        <button class="btn btn-sm btn-secondary" onclick="if(confirm('Limpar histórico de ações?')) window.location.href='{{ url_for('balanceamento.limpar_acoes', cliente_id=cliente.id) }}'">
            Limpar Histórico
        </button>
    </div>
</div>

<p></p>
{% endif %}

{% endif %}

<div class="client_area">
    <button class="bigBtn" onclick="window.location.href=`{{ url_for('cliente.info_cliente',cliente_id=cliente.id) }}`">
    <img src="{{ url_for('static', filename='icons/profile.png') }}" class="btn-icon">Informações Pessoais</button>
    
    <button class="bigBtn" onclick="window.location.href=`{{ url_for('objetivo.listar_objetivos',cliente_id=cliente.id) }}`">
    <img src="{{ url_for('static', filename='icons/objetivo.png') }}" class="btn-icon">Objetivos Financeiros</button>
       
    <button class="bigBtn" onclick="window.location.href=`{{ url_for('posicao.listar_posicao',cliente_id=cliente.id) }}`">
    <img src="{{ url_for('static', filename='icons/posicao.png') }}" class="btn-icon">Posição Financeira</button>

    <button class="bigBtn" onclick="window.location.href=`{{ url_for('balanco.iniciar', cliente_id=cliente.id) }}`">
        <img src="{{ url_for('static', filename='icons/balance.png') }}" class="btn-icon">Balancear Aporte</button>
    
    <form method="POST" action="{{ url_for('balanco.resetar_distribuicao', cliente_id=cliente.id) }}" style="display: inline;">
        <button type="submit" class="bigBtn" style="background-color: #6c757d;" onclick="return confirm('Resetar TODOS os percentuais de distribuição?')">
            <img src="{{ url_for('static', filename='icons/trash.png') }}" class="btn-icon" style="filter: brightness(0) invert(1);">Resetar Distribuição
        </button>
    </form>
</div>

<p></p>
<button title="Voltar" class="smlBtn" onclick="window.location.href=`{{ url_for('cliente.listar_clientes') }}`">
    <img src="{{ url_for('static', filename='icons/back.png') }}" class="sml-btn-icon"></button>
    
{% endblock %}