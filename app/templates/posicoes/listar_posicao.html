{% extends "base.html" %}

{% block title %}Posição Financeira - Geld's Finance{% endblock %}

{% block header %} Posição - {{cliente.nome}}{% endblock %}

{% block content %}

<!-- NOVA TABELA: Resumo por Classe de Risco -->
<h3>Resumo por Classe de Risco</h3>
<table class="table">
<thead>
    <tr>
        <th>Classe de Risco</th>
        <th>Saldo</th>
        <th>% do Portfolio</th>
    </tr>
</thead>
<tbody>
    <tr>
        <td>Fundos DI (Baixo Risco)</td>
        <td>R$ {{ '{:,.2f}'.format(saldo_fundo_di if saldo_fundo_di is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
        <td>{{ '{:.1f}%'.format((saldo_fundo_di / montante_cliente * 100) if montante_cliente > 0 and saldo_fundo_di is defined else 0).replace('.', ',') }}</td>
    </tr>
    <tr>
        <td>Renda Fixa (Baixo Risco)</td>
        <td>R$ {{ '{:,.2f}'.format(saldo_baixo if saldo_baixo is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
        <td>{{ '{:.1f}%'.format((saldo_baixo / montante_cliente * 100) if montante_cliente > 0 and saldo_baixo is defined else 0).replace('.', ',') }}</td>
    </tr>
    <tr>
        <td>Moderado Risco</td>
        <td>R$ {{ '{:,.2f}'.format(saldo_moderado if saldo_moderado is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
        <td>{{ '{:.1f}%'.format((saldo_moderado / montante_cliente * 100) if montante_cliente > 0 and saldo_moderado is defined else 0).replace('.', ',') }}</td>
    </tr>
    <tr>
        <td>Alto Risco</td>
        <td>R$ {{ '{:,.2f}'.format(saldo_alto if saldo_alto is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
        <td>{{ '{:.1f}%'.format((saldo_alto / montante_cliente * 100) if montante_cliente > 0 and saldo_alto is defined else 0).replace('.', ',') }}</td>
    </tr>
    <tr class="total-row" style="font-weight: bold; border-top: 2px solid #333;">
        <td>TOTAL GERAL</td>
        <td>R$ {{ '{:,.2f}'.format(montante_cliente if montante_cliente is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
        <td>100,0%</td>
    </tr>
</tbody>
</table>

<p></p>

<!-- Tabela de Portfolio de Fundos -->
<h3>Portfolio de Fundos</h3>

<!-- BOTÃO DELETAR SELECIONADAS -->
{% if posicoes %}
<div style="margin-bottom: 10px;">
    <button onclick="deletarSelecionadas()" class="bigBtn" style="background-color: #d9534f;" title="Deletar posições selecionadas">
        <img src="{{ url_for('static', filename='icons/trash.png') }}" class="btn-icon" style="filter: brightness(0) invert(1);"> Deletar Selecionadas
    </button>
    <span id="contador-selecionadas" style="margin-left: 10px; font-weight: bold;">0 selecionadas</span>
</div>
{% endif %}

<table class="table">
<thead>
    <tr>
        <th>
            {% if posicoes %}
            <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)" title="Selecionar todas">
            {% endif %}
        </th>
        <th>Fundo</th>
        <th>Classe Anbima</th>
        <th>Risco</th> 
        <th>Fonte</th>
        <th>Cotas</th>
        <th>Valor da cota</th>
        <th>Saldo Bruto</th>
        <th>{% if posicoes|length > 3 %}
            <button onclick="toggleExtraFunds()" id="toggle-btn" class="smlBtn" title="Mostrar todos os fundos">
                <img src="{{ url_for('static', filename='icons/expand.png') }}" class="sml-btn-icon" id="toggle-icon">
            </button>
        {% endif %}</th>
    </tr>
</thead>

<tbody>
    {% if posicoes %}
        <!-- Mostrar apenas os 3 primeiros fundos -->
        {% for posicao in posicoes[:3] %}
        <tr>
            <td>
                <input type="checkbox" class="posicao-checkbox" value="{{ posicao.id }}" onchange="updateCounter()">
            </td>
            <td>{{ " ".join(posicao.info_fundo.nome_fundo.split()[:3]) }}</td>
            <td>{{ " ".join(posicao.info_fundo.classe_anbima.split()[:2]) if posicao.info_fundo.classe_anbima else '' }}</td>
            <td>
                {% if posicao.info_fundo.risco.value == 'baixo' %}
                    {% if posicao.info_fundo.subtipo_risco and posicao.info_fundo.subtipo_risco.value == 'di' %}
                        Baixo (DI)
                    {% else %}
                        Baixo (RFx)
                    {% endif %}
                {% else %}
                    {{ posicao.info_fundo.risco.value.title() }}
                {% endif %}
            </td>
            <td>{% if posicao.banco_custodia == "BTG" %}
                <img src="{{ url_for('static', filename='icons/BTG.png') }}" class="sml-btn-icon">
                {% elif posicao.banco_custodia== "ADVISOR" %}
                <img src="{{ url_for('static', filename='icons/advisor.jpg') }}" class="sml-btn-icon">
                {% else %}
                <img src="{{ url_for('static', filename='icons/error.png') }}" class="sml-btn-icon">
                {% endif %}

            </td>
            <td>{{'{:,.2f}'.format(posicao.cotas).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
            <td>R$ {{ '{:,.2f}'.format(posicao.info_fundo.valor_cota).replace('.', ',') }}</td>
            <td>R$ {{ '{:,.2f}'.format(posicao.cotas * posicao.info_fundo.valor_cota).replace(',', ' ').replace('.', ',').replace(' ', '.')  }}</td>
            <td>
                <form action="{{ url_for('posicao.delete_posicao', posicao_id=posicao.id) }}" method="POST" class="inline">
                    <button type="submit" onclick="return confirm('Tem certeza que deseja deletar esta posição?')" class="smlBtnDel">
                        <img src="{{ url_for('static', filename='icons/trash.png') }}" class="sml-btn-icon">
                    </button>
                </form>
                
                <form action="{{ url_for('posicao.edit_posicao', posicao_id=posicao.id) }}" method="GET" class="inline">
                    <button type="submit" class="smlBtnDel">
                        <img src="{{ url_for('static', filename='icons/edit.png') }}" class="sml-btn-icon">
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
        
        <!-- Fundos restantes (ocultos inicialmente) -->
        {% if posicoes|length > 3 %}
            {% for posicao in posicoes[3:] %}
            <tr class="extra-funds" style="display: none;">
                <td>
                    <input type="checkbox" class="posicao-checkbox" value="{{ posicao.id }}" onchange="updateCounter()">
                </td>
                <td>{{ " ".join(posicao.info_fundo.nome_fundo.split()[:3]) }}</td>
                <td>{{ " ".join(posicao.info_fundo.classe_anbima.split()[:2]) if posicao.info_fundo.classe_anbima else '' }}</td>
                <td>
                    {% if posicao.info_fundo.risco.value == 'baixo' %}
                        {% if posicao.info_fundo.subtipo_risco and posicao.info_fundo.subtipo_risco.value == 'di' %}
                            Baixo (DI)
                        {% else %}
                            Baixo (RFx)
                        {% endif %}
                    {% else %}
                        {{ posicao.info_fundo.risco.value.title() }}
                    {% endif %}
                </td>
                <td>{% if posicao.banco_custodia == "BTG" %}
                <img src="{{ url_for('static', filename='icons/BTG.png') }}" class="sml-btn-icon">
                {% elif posicao.banco_custodia== "ADVISOR" %}
                <img src="{{ url_for('static', filename='icons/advisor.jpg') }}" class="sml-btn-icon">
                {% else %}
                <img src="{{ url_for('static', filename='icons/error.png') }}" class="sml-btn-icon">
                {% endif %}

            </td>
                <td>{{'{:,.2f}'.format(posicao.cotas).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>R$ {{ '{:,.2f}'.format(posicao.info_fundo.valor_cota).replace('.', ',') }}</td>
                <td>R$ {{ '{:,.2f}'.format(posicao.cotas * posicao.info_fundo.valor_cota).replace(',', ' ').replace('.', ',').replace(' ', '.')  }}</td>
                <td>
                    <form action="{{ url_for('posicao.delete_posicao', posicao_id=posicao.id) }}" method="POST" class="inline">
                        <button type="submit" onclick="return confirm('Tem certeza que deseja deletar esta posição?')" class="smlBtnDel">
                            <img src="{{ url_for('static', filename='icons/trash.png') }}" class="sml-btn-icon">
                        </button>
                    </form>
                    
                    <form action="{{ url_for('posicao.edit_posicao', posicao_id=posicao.id) }}" method="GET" class="inline">
                        <button type="submit" class="smlBtnDel">
                            <img src="{{ url_for('static', filename='icons/edit.png') }}" class="sml-btn-icon">
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        {% endif %}
    {% else %}
        <tr>
            <td colspan="9">Nenhuma posição em fundos cadastrada</td>
        </tr>
    {% endif %}
    
    <th></th>
    <th>TOTAL</th>
    <th colspan="5"></th>
    <th>R$ {{ '{:,.2f}'.format(montante_cliente if montante_cliente is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</th>
    <td>
        {% if posicoes|length > 3 %}
            <button onclick="toggleExtraFunds()" id="toggle-btn" class="smlBtn" title="Mostrar todos os fundos">
                <img src="{{ url_for('static', filename='icons/expand.png') }}" class="sml-btn-icon" id="toggle-icon">
            </button>
        {% endif %}
    </td>
</tbody>
</table>

<p></p>
<div class="inline-btn">
    <button title="Voltar" class="smlBtn" onclick="window.location.href=`{{url_for('cliente.area_cliente',cliente_id=cliente.id) }}`">
        <img src="{{ url_for('static', filename='icons/back.png') }}" class="sml-btn-icon"></button>

    <button title="Adicionar Posição" class="smlBtn" onclick="window.location.href=`{{ url_for('posicao.add_posicao', cliente_id=cliente.id) }}` ">
        <img src="{{ url_for('static', filename='icons/add.png') }}" class="sml-btn-icon">
    </button>
</div>

<div class="inline-btn">
    <button title="upload_btg" class="bigBtn" onclick="window.location.href=`{{ url_for('posicao.upload_cotas', cliente_id=cliente.id) }}` ">
    <img src="{{ url_for('static', filename='icons/btg.png') }}" class="btn-icon"> Upload Portfolio BTG
    </button>


    <button title="upload_advisor" class="bigBtn" onclick="window.location.href=`{{ url_for('posicao_advisor.upload_advisor', cliente_id=cliente.id) }}` ">
    <img src="{{ url_for('static', filename='icons/advisor.jpg') }}" class="btn-icon"> Upload Portfolio Advisor
    </button>
    
    <button title="balancear aporte" class="bigBtn" onclick="window.location.href=`{{ url_for('objetivo.listar_objetivos', cliente_id=cliente.id) }}`">
        <img src="{{ url_for('static', filename='icons/balance.png') }}" class="btn-icon">Balancear Aporte
    </button>
</div>

<script>
// Toggle expandir/recolher fundos extras
function toggleExtraFunds() {
    const extraFunds = document.querySelectorAll('.extra-funds');
    const toggleBtn = document.getElementById('toggle-btn');
    const toggleIcon = document.getElementById('toggle-icon');
    
    const isVisible = extraFunds[0].style.display !== 'none';
    
    extraFunds.forEach(row => {
        row.style.display = isVisible ? 'none' : '';
    });
    
    if (isVisible) {
        toggleBtn.title = "Mostrar todos os fundos";
        toggleIcon.src = "{{ url_for('static', filename='icons/expand.png') }}";
    } else {
        toggleBtn.title = "Ocultar fundos extras";
        toggleIcon.src = "{{ url_for('static', filename='icons/collapse.png') }}";
    }
}

// Selecionar/Desselecionar todas as checkboxes
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.posicao-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateCounter();
}

// Atualizar contador de selecionadas
function updateCounter() {
    const checkboxes = document.querySelectorAll('.posicao-checkbox:checked');
    const counter = document.getElementById('contador-selecionadas');
    const count = checkboxes.length;
    
    counter.textContent = `${count} selecionada${count !== 1 ? 's' : ''}`;
    
    // Atualizar estado do "select-all"
    const selectAll = document.getElementById('select-all');
    const allCheckboxes = document.querySelectorAll('.posicao-checkbox');
    
    if (selectAll) {
        selectAll.checked = count === allCheckboxes.length && count > 0;
    }
}

// Deletar posições selecionadas
function deletarSelecionadas() {
    const checkboxes = document.querySelectorAll('.posicao-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Selecione pelo menos uma posição para deletar.');
        return;
    }
    
    const count = checkboxes.length;
    const confirmMsg = `Tem certeza que deseja deletar ${count} posição${count !== 1 ? 'ões' : ''}?`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    // Coletar IDs das posições selecionadas
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    // Criar formulário dinamicamente para enviar via POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{{ url_for('posicao.delete_multiple_posicoes', cliente_id=cliente.id) }}";
    
    // Adicionar IDs como campos hidden
    ids.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'posicao_ids';
        input.value = id;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}
</script>

{% endblock %}