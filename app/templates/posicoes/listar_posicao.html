{% extends "base.html" %}

{% block title %}Posição Financeira - Geld's Finance{% endblock %}

{% block header %} Posição - {{cliente.nome}}{% endblock %}

{% block content %}

<style>
.filtro-dropdown {
    display: block;
    margin-top: 5px;
    padding: 4px 8px;
    font-size: 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: white;
    cursor: pointer;
    width: 100%;
    max-width: 150px;
}

.filtro-dropdown:hover {
    border-color: #999;
}

.filtro-dropdown:focus {
    outline: none;
    border-color: #4CAF50;
}
</style>


<h3>Resumo por Classe de Risco</h3>
<table class="table">
<thead>
    <tr>
        <th>Classe de Risco</th>
        <th>Saldo</th>
        <th>% do Portfolio</th>
    </tr>
</thead>
<tbody>
    <tr>
        <td>Fundos DI (Baixo Risco)</td>
        <td>R$ {{ '{:,.2f}'.format(saldo_fundo_di if saldo_fundo_di is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
        <td>{{ '{:.1f}%'.format((saldo_fundo_di / montante_cliente * 100) if montante_cliente > 0 and saldo_fundo_di is defined else 0).replace('.', ',') }}</td>
    </tr>
    <tr>
        <td>Renda Fixa (Baixo Risco)</td>
        <td>R$ {{ '{:,.2f}'.format(saldo_baixo if saldo_baixo is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
        <td>{{ '{:.1f}%'.format((saldo_baixo / montante_cliente * 100) if montante_cliente > 0 and saldo_baixo is defined else 0).replace('.', ',') }}</td>
    </tr>
    <tr>
        <td>Moderado Risco</td>
        <td>R$ {{ '{:,.2f}'.format(saldo_moderado if saldo_moderado is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
        <td>{{ '{:.1f}%'.format((saldo_moderado / montante_cliente * 100) if montante_cliente > 0 and saldo_moderado is defined else 0).replace('.', ',') }}</td>
    </tr>
    <tr>
        <td>Alto Risco</td>
        <td>R$ {{ '{:,.2f}'.format(saldo_alto if saldo_alto is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
        <td>{{ '{:.1f}%'.format((saldo_alto / montante_cliente * 100) if montante_cliente > 0 and saldo_alto is defined else 0).replace('.', ',') }}</td>
    </tr>
    <tr class="total-row" style="font-weight: bold; border-top: 2px solid #333;">
        <td>TOTAL GERAL</td>
        <td>R$ {{ '{:,.2f}'.format(montante_cliente if montante_cliente is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
        <td>100,0%</td>
    </tr>
</tbody>
</table>

<p></p>


<h3>Portfolio de Fundos</h3>


{% if posicoes %}
<div style="margin-bottom: 10px;">
    <button onclick="deletarSelecionadas()" class="bigBtn" style="background-color: #d9534f;" title="Deletar posições selecionadas">
        <img src="{{ url_for('static', filename='icons/trash.png') }}" class="btn-icon" style="filter: brightness(0) invert(1);"> Deletar Selecionadas
    </button>
    <span id="contador-selecionadas" style="margin-left: 10px; font-weight: bold;">0 selecionadas</span>
</div>
{% endif %}

<table class="table" id="tabela-posicoes">
<thead>
    <tr>
        <th>
            {% if posicoes %}
            <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)" title="Selecionar todas">
            {% endif %}
        </th>
        <th>Fundo</th>
        <th>
            Classe Anbima
            <select id="filtro-classe" onchange="aplicarFiltros()" class="filtro-dropdown">
                <option value="">Todos</option>
            </select>
        </th>
        <th>
            Risco
            <select id="filtro-risco" onchange="aplicarFiltros()" class="filtro-dropdown">
                <option value="">Todos</option>
                <option value="baixo-di">Baixo (DI)</option>
                <option value="baixo-rfx">Baixo (RFx)</option>
                <option value="moderado">Moderado</option>
                <option value="alto">Alto</option>
            </select>
        </th> 
        <th>
            Fonte
            <select id="filtro-fonte" onchange="aplicarFiltros()" class="filtro-dropdown">
                <option value="">Todos</option>
                <option value="BTG">BTG</option>
                <option value="ADVISOR">Advisor</option>
            </select>
        </th>
        <th>Cotas</th>
        <th>Valor da cota</th>
        <th>Saldo Bruto</th>
        <th>
            {% if posicoes|length > 4 %}
            <button onclick="toggleExtraFunds()" id="toggle-btn" class="smlBtn" title="Mostrar todos os fundos">
                <img src="{{ url_for('static', filename='icons/expand.png') }}" class="sml-btn-icon" id="toggle-icon">
            </button>
            {% endif %}
            <button onclick="limparFiltros()" class="smlBtn" title="Limpar todos os filtros">
                <img src="{{ url_for('static', filename='icons/clean_filter.png') }}" class="sml-btn-icon">
            </button>
        </th>
    </tr>
</thead>

<tbody>
    {% if posicoes %}
        <!-- Mostrar apenas os 4 primeiros fundos -->
        {% for posicao in posicoes[:4] %}
        <tr data-classe="{{ posicao.info_fundo.classe_anbima if posicao.info_fundo.classe_anbima else '' }}"
            data-risco="{% if posicao.info_fundo.risco.value == 'baixo' %}{% if posicao.info_fundo.subtipo_risco and posicao.info_fundo.subtipo_risco.value == 'di' %}baixo-di{% else %}baixo-rfx{% endif %}{% else %}{{ posicao.info_fundo.risco.value }}{% endif %}"
            data-fonte="{{ posicao.banco_custodia if posicao.banco_custodia else '' }}">
            <td>
                <input type="checkbox" class="posicao-checkbox" value="{{ posicao.id }}" onchange="updateCounter()">
            </td>
            <td>{{ " ".join(posicao.info_fundo.nome_fundo.split()[:4]) }}</td>
            <td>{{ " ".join(posicao.info_fundo.classe_anbima.split()[:4]) if posicao.info_fundo.classe_anbima else '' }}</td>
            <td>
                {% if posicao.info_fundo.risco.value == 'baixo' %}
                    {% if posicao.info_fundo.subtipo_risco and posicao.info_fundo.subtipo_risco.value == 'di' %}
                        Baixo (DI)
                    {% else %}
                        Baixo (RFx)
                    {% endif %}
                {% else %}
                    {{ posicao.info_fundo.risco.value.title() }}
                {% endif %}
            </td>
            <td>{% if posicao.banco_custodia == "BTG" %}
                <img src="{{ url_for('static', filename='icons/BTG.png') }}" class="sml-btn-icon">
                {% elif posicao.banco_custodia== "ADVISOR" %}
                <img src="{{ url_for('static', filename='icons/advisor.jpg') }}" class="sml-btn-icon">
                {% else %}
                <img src="{{ url_for('static', filename='icons/error.png') }}" class="sml-btn-icon">
                {% endif %}

            </td>
            <td>{{'{:,.2f}'.format(posicao.cotas).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
            <td>R$ {{ '{:,.2f}'.format(posicao.info_fundo.valor_cota).replace('.', ',') }}</td>
            <td>R$ {{ '{:,.2f}'.format(posicao.cotas * posicao.info_fundo.valor_cota).replace(',', ' ').replace('.', ',').replace(' ', '.')  }}</td>
            <td>
                <form action="{{ url_for('posicao.delete_posicao', posicao_id=posicao.id) }}" method="POST" class="inline">
                    <button type="submit" onclick="return confirm('Tem certeza que deseja deletar esta posição?')" class="smlBtnDel">
                        <img src="{{ url_for('static', filename='icons/trash.png') }}" class="sml-btn-icon">
                    </button>
                </form>
                
                <form action="{{ url_for('posicao.edit_posicao', posicao_id=posicao.id) }}" method="GET" class="inline">
                    <button type="submit" class="smlBtnDel">
                        <img src="{{ url_for('static', filename='icons/edit.png') }}" class="sml-btn-icon">
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
        
        <!-- Fundos restantes (ocultos inicialmente) -->
        {% if posicoes|length > 4 %}
            {% for posicao in posicoes[4:] %}
            <tr class="extra-funds" style="display: none;"
                data-classe="{{ posicao.info_fundo.classe_anbima if posicao.info_fundo.classe_anbima else '' }}"
                data-risco="{% if posicao.info_fundo.risco.value == 'baixo' %}{% if posicao.info_fundo.subtipo_risco and posicao.info_fundo.subtipo_risco.value == 'di' %}baixo-di{% else %}baixo-rfx{% endif %}{% else %}{{ posicao.info_fundo.risco.value }}{% endif %}"
                data-fonte="{{ posicao.banco_custodia if posicao.banco_custodia else '' }}">
                <td>
                    <input type="checkbox" class="posicao-checkbox" value="{{ posicao.id }}" onchange="updateCounter()">
                </td>
                <td>{{ " ".join(posicao.info_fundo.nome_fundo.split()[:4]) }}</td>
                <td>{{ " ".join(posicao.info_fundo.classe_anbima.split()[:4]) if posicao.info_fundo.classe_anbima else '' }}</td>
                <td>
                    {% if posicao.info_fundo.risco.value == 'baixo' %}
                        {% if posicao.info_fundo.subtipo_risco and posicao.info_fundo.subtipo_risco.value == 'di' %}
                            Baixo (DI)
                        {% else %}
                            Baixo (RFx)
                        {% endif %}
                    {% else %}
                        {{ posicao.info_fundo.risco.value.title() }}
                    {% endif %}
                </td>
                <td>{% if posicao.banco_custodia == "BTG" %}
                <img src="{{ url_for('static', filename='icons/BTG.png') }}" class="sml-btn-icon">
                {% elif posicao.banco_custodia== "ADVISOR" %}
                <img src="{{ url_for('static', filename='icons/advisor.jpg') }}" class="sml-btn-icon">
                {% else %}
                <img src="{{ url_for('static', filename='icons/error.png') }}" class="sml-btn-icon">
                {% endif %}

            </td>
                <td>{{'{:,.2f}'.format(posicao.cotas).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>R$ {{ '{:,.2f}'.format(posicao.info_fundo.valor_cota).replace('.', ',') }}</td>
                <td>R$ {{ '{:,.2f}'.format(posicao.cotas * posicao.info_fundo.valor_cota).replace(',', ' ').replace('.', ',').replace(' ', '.')  }}</td>
                <td>
                    <form action="{{ url_for('posicao.delete_posicao', posicao_id=posicao.id) }}" method="POST" class="inline">
                        <button type="submit" onclick="return confirm('Tem certeza que deseja deletar esta posição?')" class="smlBtnDel">
                            <img src="{{ url_for('static', filename='icons/trash.png') }}" class="sml-btn-icon">
                        </button>
                    </form>
                    
                    <form action="{{ url_for('posicao.edit_posicao', posicao_id=posicao.id) }}" method="GET" class="inline">
                        <button type="submit" class="smlBtnDel">
                            <img src="{{ url_for('static', filename='icons/edit.png') }}" class="sml-btn-icon">
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        {% endif %}
    {% else %}
        <tr>
            <td colspan="9">Nenhuma posição em fundos cadastrada</td>
        </tr>
    {% endif %}
    
    <th></th>
    <th>TOTAL</th>
    <th colspan="5"></th>
    <th>R$ {{ '{:,.2f}'.format(montante_cliente if montante_cliente is defined else 0).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</th>
    <td>
        {% if posicoes|length > 4 %}
            <button onclick="toggleExtraFunds()" id="toggle-btn" class="smlBtn" title="Mostrar todos os fundos">
                <img src="{{ url_for('static', filename='icons/expand.png') }}" class="sml-btn-icon" id="toggle-icon">
            </button>
        {% endif %}
    </td>
</tbody>
</table>

<p></p>
<div class="inline-btn">
    <button title="Voltar" class="smlBtn" onclick="window.location.href=`{{url_for('cliente.area_cliente',cliente_id=cliente.id) }}`">
        <img src="{{ url_for('static', filename='icons/back.png') }}" class="sml-btn-icon"></button>

    <button title="Adicionar Posição" class="smlBtn" onclick="window.location.href=`{{ url_for('posicao.add_posicao', cliente_id=cliente.id) }}` ">
        <img src="{{ url_for('static', filename='icons/add.png') }}" class="sml-btn-icon">
    </button>
</div>

<div class="inline-btn">
    <button title="upload_btg" class="bigBtn" onclick="window.location.href=`{{ url_for('posicao.upload_cotas', cliente_id=cliente.id) }}` ">
    <img src="{{ url_for('static', filename='icons/BTG.png') }}" class="btn-icon"> Upload Portfolio BTG
    </button>


    <button title="upload_advisor" class="bigBtn" onclick="window.location.href=`{{ url_for('posicao_advisor.upload_advisor', cliente_id=cliente.id) }}` ">
    <img src="{{ url_for('static', filename='icons/advisor.jpg') }}" class="btn-icon"> Upload Portfolio Advisor
    </button>
    
    <button title="balancear_aporte" class="bigBtn" onclick="window.location.href=`{{ url_for('balanco.iniciar', cliente_id=cliente.id) }}` ">
        <img src="{{ url_for('static', filename='icons/balance.png') }}" class="btn-icon"> Balancear Aporte
        </button>
</div>

<script>
// Toggle expandir/recolher fundos extras
function toggleExtraFunds() {
    const extraFunds = document.querySelectorAll('.extra-funds');
    const toggleBtn = document.getElementById('toggle-btn');
    const toggleIcon = document.getElementById('toggle-icon');
    
    const isVisible = extraFunds[0].style.display !== 'none';
    
    extraFunds.forEach(row => {
        row.style.display = isVisible ? 'none' : '';
    });
    
    if (isVisible) {
        toggleBtn.title = "Mostrar todos os fundos";
        toggleIcon.src = "{{ url_for('static', filename='icons/expand.png') }}";
    } else {
        toggleBtn.title = "Ocultar fundos extras";
        toggleIcon.src = "{{ url_for('static', filename='icons/collapse.png') }}";
    }
}

// Selecionar/Desselecionar todas as checkboxes
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.posicao-checkbox');
    checkboxes.forEach(cb => {
        // Só marcar as checkboxes visíveis (que não foram filtradas)
        const row = cb.closest('tr');
        if (row.style.display !== 'none') {
            cb.checked = checkbox.checked;
        }
    });
    updateCounter();
}

// Atualizar contador de selecionadas
function updateCounter() {
    const checkboxes = document.querySelectorAll('.posicao-checkbox:checked');
    const counter = document.getElementById('contador-selecionadas');
    const count = checkboxes.length;
    
    counter.textContent = `${count} selecionada${count !== 1 ? 's' : ''}`;
    
    // Atualizar estado do "select-all"
    const selectAll = document.getElementById('select-all');
    const allCheckboxes = document.querySelectorAll('.posicao-checkbox');
    const visibleCheckboxes = Array.from(allCheckboxes).filter(cb => cb.closest('tr').style.display !== 'none');
    
    if (selectAll && visibleCheckboxes.length > 0) {
        const checkedVisible = visibleCheckboxes.filter(cb => cb.checked).length;
        selectAll.checked = checkedVisible === visibleCheckboxes.length && checkedVisible > 0;
    }
}

// Aplicar filtros na tabela
function aplicarFiltros() {
    const filtroClasse = document.getElementById('filtro-classe').value.toLowerCase();
    const filtroRisco = document.getElementById('filtro-risco').value.toLowerCase();
    const filtroFonte = document.getElementById('filtro-fonte').value.toUpperCase();
    
    const rows = document.querySelectorAll('#tabela-posicoes tbody tr');
    
    rows.forEach(row => {
        const classe = row.getAttribute('data-classe').toLowerCase();
        const risco = row.getAttribute('data-risco').toLowerCase();
        const fonte = row.getAttribute('data-fonte').toUpperCase();
        
        const matchClasse = !filtroClasse || classe.includes(filtroClasse);
        const matchRisco = !filtroRisco || risco === filtroRisco;
        const matchFonte = !filtroFonte || fonte === filtroFonte;
        
        if (matchClasse && matchRisco && matchFonte) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
            // Desmarcar checkbox de linhas ocultas
            const checkbox = row.querySelector('.posicao-checkbox');
            if (checkbox) checkbox.checked = false;
        }
    });
    
    updateCounter();
}

// Limpar todos os filtros
function limparFiltros() {
    document.getElementById('filtro-classe').value = '';
    document.getElementById('filtro-risco').value = '';
    document.getElementById('filtro-fonte').value = '';
    aplicarFiltros();
}

// Popular dropdown de Classe Anbima com valores únicos
function popularFiltroClasse() {
    const filtroClasse = document.getElementById('filtro-classe');
    const classes = new Set();
    
    const rows = document.querySelectorAll('#tabela-posicoes tbody tr');
    rows.forEach(row => {
        const classe = row.getAttribute('data-classe');
        if (classe) {
            // Pegar apenas as 2 primeiras palavras
            const classeSimples = classe.split(' ').slice(0, 2).join(' ');
            classes.add(classeSimples);
        }
    });
    
    // Ordenar e adicionar opções
    Array.from(classes).sort().forEach(classe => {
        const option = document.createElement('option');
        option.value = classe;
        option.textContent = classe;
        filtroClasse.appendChild(option);
    });
}

// Executar ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    popularFiltroClasse();
});


// Deletar posições selecionadas
function deletarSelecionadas() {
    const checkboxes = document.querySelectorAll('.posicao-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Selecione pelo menos uma posição para deletar.');
        return;
    }
    
    const count = checkboxes.length;
    const confirmMsg = `Tem certeza que deseja deletar ${count} posição${count !== 1 ? 'ões' : ''}?`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    // Coletar IDs das posições selecionadas
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    // Criar formulário dinamicamente para enviar via POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{{ url_for('posicao.delete_multiple_posicoes', cliente_id=cliente.id) }}";
    
    // Adicionar IDs como campos hidden
    ids.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'posicao_ids';
        input.value = id;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}
</script>

{% endblock %}