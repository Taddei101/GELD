{% extends 'base.html' %}
{% block title %}Upload de Posições BTG{% endblock %}
{% block header %}Upload Portfólio: {{ cliente.nome }}{% endblock %}
{% block content %}
<div class="upload-container">
    <h2>Upload de Posições BTG</h2>
    
    <!-- Exibir mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="info-card">
        <p>Essa função requer um arquivo exportado do banco BTG-Pactual:</p>
        <p>Para isso, na página inicial, clique em documentos, extratos de investimentos consultar, extrato personalizado Solicitar.</p>
        <p>Lembre de que o tipo de documento deve ser detalhado, formato do documento Excel (.xlsx) no idioma português-BR.</p>
        
        <p>O sistema irá:</p>
        <ul>
            <li>Abrir a aba "Fundos" do arquivo</li>
            <li>Extrair os CNPJs, número de cotas e datas das posições</li>
            <li>Verificar se os fundos estão cadastrados na base de dados</li>
            <li>Cadastrar fundos novos automaticamente</li>
            <li>Registrar as posições para o cliente</li>
        </ul>
    </div>

    <!-- FORMULÁRIO CORRIGIDO: Agora com enctype para upload de arquivo -->
    <form action="{{ url_for('posicao.upload_cotas', cliente_id=cliente.id) }}" 
          method="POST" 
          enctype="multipart/form-data">
        
        <div class="form-group">
            <label for="arquivo">Selecione o arquivo Excel (.xlsx):</label>
            <input type="file" 
                   id="arquivo" 
                   name="arquivo" 
                   accept=".xlsx,.xls" 
                   required>
            <small class="form-text text-muted">
                Apenas arquivos Excel (.xlsx, .xls). Tamanho máximo: 16MB
            </small>
        </div>
        
        <button type="submit" class="bigBtn">
            <img src="{{ url_for('static', filename='icons/upload.png') }}" class="btn-icon"> 
            Processar Arquivo
        </button>
    </form>
    
    <p></p>
    <button title="Voltar" 
            class="smlBtn" 
            onclick="window.location.href='{{ url_for('posicao.listar_posicao', cliente_id=cliente.id) }}'">
        <img src="{{ url_for('static', filename='icons/back.png') }}" class="sml-btn-icon">
    </button>
</div>

<style>
.form-group {
    margin: 20px 0;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 2px dashed #ccc;
    border-radius: 5px;
    background-color: #f9f9f9;
}

.form-group input[type="file"]:hover {
    border-color: #007bff;
    background-color: #f0f8ff;
}

.form-text {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;
}

.alert {
    padding: 10px;
    margin: 10px 0;
    border-radius: 5px;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-danger {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
{% endblock %}