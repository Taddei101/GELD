{% extends "base.html" %}

{% block title %}Objetivos Financeiros - Geld's Finance{% endblock %}

{% block header %}Objetivos de {{cliente.nome}} {% endblock %}

{% block content %}
<div class="center">
    <table class="table">
        <thead>
            <tr>
                <th>Objetivo</th>
                <th>Tipo</th>
                <th>Data Inicial</th>
                <th>Data Final</th>
                <th>Período Restante</th>
                <th>Valor Desejado</th>
                <th class="tooltip" data-tooltip="Valor Desejado aplicado inflação no final do período">Valor Futuro</th>
                <th class="tooltip" data-tooltip="Valor necessário atualmente para atingir o objetivo com IPCA+3,5%">Valor Presente</th>
                <th>Montante</th>
                {% if mostrar_calculo is defined and mostrar_calculo %}
                <th>Aporte Mensal</th>
                {% endif %}
                <th><img src="{{ url_for('static', filename='icons/cog.png') }}" class="img"></th>
                <th><img src="{{ url_for('static', filename='icons/trophy.png') }}" class="img"></th>
            </tr>
        </thead>
        <tbody>
            {% for objetivo in objetivos %}
            <tr>
                <td>{{ objetivo.nome_objetivo }}</td>
                <td><span class="badge-tipo-objetivo {{ 'badge-previdencia' if objetivo.tipo_objetivo.value == 'previdencia' else 'badge-geral' }}">
                 {{ objetivo.tipo_objetivo.value.title() }}</span>
                </td>
                <td>{{ objetivo.data_inicial.strftime('%d/%m/%Y')  }}</td>
                <td>{{ objetivo.data_final.strftime('%d/%m/%Y') }}</td>
                <td>{{ objetivo.duracao_meses}} meses</td>
                <td>R$ {{ '{:,.2f}'.format(objetivo.valor_final).replace(',', ' ').replace('.', ',').replace(' ', '.') }} </td>
                <td>R$ {{ '{:,.2f}'.format(objetivo.valor_final|float * ((1+ipca_mes/100)**((objetivo.data_final.year - objetivo.data_inicial.year) * 12 + (objetivo.data_final.month - objetivo.data_inicial.month)))).replace(',', ' ').replace('.', ',').replace(' ', '.') }}</td>
                <td>
                    R$ {{ '{:,.2f}'.format(vp_ideal_por_objetivo[objetivo.id]).replace(',', ' ').replace('.', ',').replace(' ', '.') }}
                </td>
                
                {# VALOR ATUAL CALCULADO DINAMICAMENTE #}
                <td>
                    {% if valores_por_objetivo and objetivo.id in valores_por_objetivo %}
                        {% set valor_atual = valores_por_objetivo[objetivo.id].get('total', 0) if valores_por_objetivo[objetivo.id] is mapping else valores_por_objetivo[objetivo.id] %}
                    {% else %}
                        {% set valor_atual = 0 %}
                    {% endif %}
                    R$ {{ '{:,.2f}'.format(valor_atual).replace(',', ' ').replace('.', ',').replace(' ', '.') }}
                </td>
                
                

                <td>
                    <form action="{{ url_for('objetivo.edit_objetivo', objetivo_id=objetivo.id) }}" method="GET">
                        <button class="smlBtn"><img src="{{ url_for('static', filename='icons/edit.png') }}" class="sml-btn-icon"></button>
                    </form>
                
                    <form action="{{ url_for('objetivo.delete_objetivo', objetivo_id=objetivo.id) }}" method="POST" class="inline">
                        <button type="submit" onclick="return confirm('Tem certeza que deseja deletar este objetivo?')" class="smlBtnDel">
                        <img src="{{ url_for('static', filename='icons/trash.png') }}" class="sml-btn-icon"></button>
                    </form>
                </td>

                <td>
                    <div class="progress-bar-container">
                      <div class="progress-bar-vertical">
                        {% if objetivo.valor_final > 0 %}
                          {#  USAR VALOR ATUAL CALCULADO PARA A BARRA DE PROGRESSO #}
                          {% if valores_por_objetivo and objetivo.id in valores_por_objetivo %}
                              {% set valor_dict = valores_por_objetivo[objetivo.id] %}
                              {% set valor_atual_obj = valor_dict.get('total', 0) if valor_dict is mapping else valor_dict %}
                          {% else %}
                              {% set valor_atual_obj = 0 %}
                          {% endif %}
                          
                          {% set valor_futuro_obj = objetivo.valor_final|float * ((1+ipca_mes/100)**((objetivo.data_final.year - objetivo.data_inicial.year) * 12 + (objetivo.data_final.month - objetivo.data_inicial.month))) %}
                          {% set percentage = ((valor_atual_obj / valor_futuro_obj) * 100)|round(0)|int %}
                          {# {% if percentage > 100 %}{% set percentage = 100 %}{% endif %} #}
                                                   
                          <div class="progress-fill" style="height: {{ percentage }}%"></div>
                          <span class="percentage-text">{{ percentage }}%</span>
                        {% else %}
                          <div class="progress-fill" style="height: 0%"></div>
                          <span class="percentage-text">0%</span>
                        {% endif %}
                      </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
            
            
        </tbody>
    </table>

    <p></p>

    <div class="inline-btn">
        <button title="Adicionar" class="smlBtn {% if not objetivos %}btn-orfao{% endif %}" 
            onclick="window.location.href='{{ url_for('objetivo.add_objetivo', cliente_id=cliente.id) }}'">
            <img src="{{ url_for('static', filename='icons/add.png') }}" class="sml-btn-icon">
        </button>

        <button title="Voltar" class="smlBtn" onclick="window.location.href='{{ url_for('cliente.area_cliente', cliente_id=cliente.id) }}'">
            <img src="{{ url_for('static', filename='icons/back.png') }}" class="sml-btn-icon">
        </button>

        {% if objetivos %}
        <button title="balancear_aporte" class="bigBtn" onclick="window.location.href=`{{ url_for('balanco.iniciar', cliente_id=cliente.id) }}` ">
        <img src="{{ url_for('static', filename='icons/balance.png') }}" class="btn-icon"> Balancear Aporte
        </button>
        {% endif %}
    </div> 
</div>

{% endblock %}